/**
 * SleepRules - CBT-I Rules for Memory Consolidation
 * ==================================================
 *
 * Evidence-based sleep rules from CBT-I protocols,
 * formatted for pre-sleep mental rehearsal and morning recall.
 *
 * Sources:
 * - Spielman et al. (1987) - Sleep Restriction Therapy
 * - Bootzin (1972) - Stimulus Control
 * - Morin & Espie (2003) - Insomnia: A Clinical Guide
 * - European Insomnia Guideline (2023)
 *
 * @packageDocumentation
 * @module @sleepcore/cognitive
 */

import type { ISleepRule, SleepRuleCategory } from '../interfaces/ICognitiveConsolidation';

/**
 * Complete CBT-I Sleep Rules Database
 * Organized by category with visualization prompts
 */
export const SLEEP_RULES: readonly ISleepRule[] = [
  // =========================================================================
  // STIMULUS CONTROL RULES (Bootzin, 1972)
  // =========================================================================
  {
    id: 'sc-01',
    category: 'stimulus_control',
    statement: 'Ложитесь в постель только когда чувствуете сонливость',
    explanation:
      'Сонливость отличается от усталости. Сонливость — это когда глаза сами закрываются, ' +
      'голова тяжелеет, мысли становятся размытыми. Усталость — это просто нехватка энергии. ' +
      'Ложиться нужно именно при сонливости.',
    visualizationPrompt:
      'Представьте: вечер, вы на диване читаете книгу. Буквы начинают расплываться, ' +
      'веки становятся тяжёлыми, голова клонится. Вы чувствуете приятную сонливость. ' +
      'Только сейчас вы встаёте и идёте в спальню.',
    rationale:
      'Когда вы ложитесь сонным, мозг связывает кровать с быстрым засыпанием. ' +
      'Это как условный рефлекс — кровать = сон.',
    difficulty: 2,
    relatedRuleIds: ['sc-02', 'sc-03'],
  },
  {
    id: 'sc-02',
    category: 'stimulus_control',
    statement: 'Используйте кровать только для сна (и близости)',
    explanation:
      'Никакого чтения, телефона, телевизора, работы или еды в постели. ' +
      'Кровать должна ассоциироваться только со сном.',
    visualizationPrompt:
      'Представьте свою спальню. Это тихое, тёмное место только для сна. ' +
      'Телефон остаётся за дверью. Ноутбук — в другой комнате. ' +
      'Кровать — это ваше личное пространство для отдыха и восстановления.',
    rationale:
      'Мозг учится по ассоциациям. Если вы работаете в постели, мозг связывает ' +
      'кровать с активностью и бодрствованием вместо сна.',
    difficulty: 3,
    relatedRuleIds: ['sc-01', 'sc-03'],
  },
  {
    id: 'sc-03',
    category: 'stimulus_control',
    statement: 'Если не уснули за 15-20 минут — встаньте с кровати',
    explanation:
      'Не смотрите на часы — просто если чувствуете, что сон не приходит, ' +
      'выйдите из спальни. Займитесь чем-то спокойным при тусклом свете. ' +
      'Вернитесь только когда снова почувствуете сонливость.',
    visualizationPrompt:
      'Вы лежите в темноте, но сон не приходит. Без раздражения вы встаёте, ' +
      'накидываете халат, идёте в гостиную. Там тусклый свет, вы садитесь в кресло ' +
      'и слушаете тихую музыку или читаете скучную книгу. Через некоторое время ' +
      'сонливость возвращается, и вы спокойно идёте обратно в спальню.',
    rationale:
      'Лежание без сна учит мозг, что кровать — место для бодрствования. ' +
      'Выход из кровати разрывает эту связь.',
    difficulty: 4,
    relatedRuleIds: ['sc-01', 'sc-02'],
  },
  {
    id: 'sc-04',
    category: 'stimulus_control',
    statement: 'Вставайте в одно и то же время каждый день',
    explanation:
      'Даже в выходные. Даже если плохо спали. Фиксированное время подъёма — ' +
      'якорь для вашего циркадного ритма.',
    visualizationPrompt:
      'Утро. Будильник звонит в 7:00. Вы открываете глаза, потягиваетесь, ' +
      'и сразу встаёте. Не важно, суббота это или понедельник. ' +
      'Вы включаете свет, раздвигаете шторы — утренний свет даёт сигнал мозгу: день начался.',
    rationale:
      'Постоянное время подъёма синхронизирует ваши внутренние часы. ' +
      'Это самое важное для здорового сна.',
    difficulty: 3,
    relatedRuleIds: ['sr-01', 'sh-06'],
  },
  {
    id: 'sc-05',
    category: 'stimulus_control',
    statement: 'Не спите днём (или не более 20 минут до 15:00)',
    explanation:
      'Дневной сон снижает давление сна к вечеру. Если очень хотите вздремнуть — ' +
      'только короткий сон (power nap) и только в первой половине дня.',
    visualizationPrompt:
      'После обеда вы чувствуете усталость. Вместо того чтобы лечь, ' +
      'вы выходите на короткую прогулку на свежий воздух. Солнечный свет и движение ' +
      'придают энергии. К вечеру накопится здоровое давление сна.',
    rationale:
      'Давление сна накапливается в течение дня. Дневной сон "сбрасывает" это давление, ' +
      'и вечером труднее уснуть.',
    difficulty: 2,
    relatedRuleIds: ['sr-01', 'sh-04'],
  },

  // =========================================================================
  // SLEEP RESTRICTION RULES (Spielman, 1987)
  // =========================================================================
  {
    id: 'sr-01',
    category: 'sleep_restriction',
    statement: 'Проводите в постели столько времени, сколько реально спите',
    explanation:
      'Если вы спите 5 часов, но лежите 8 — это неэффективно. ' +
      'Временно ограничьте время в постели до реального времени сна ' +
      '(минимум 5 часов). Это создаёт здоровое давление сна.',
    visualizationPrompt:
      'Представьте: ваше время в постели — с 00:00 до 06:00. Всего 6 часов. ' +
      'Вы ложитесь ровно в полночь, уже сонный. Засыпаете быстро, спите крепко, ' +
      'просыпаетесь в 6:00 бодрым. Это эффективный, глубокий сон.',
    rationale:
      'Ограничение времени в постели повышает "давление сна" и улучшает ' +
      'качество сна. Это как аппетит — если вы голодны, еда вкуснее.',
    difficulty: 5,
    relatedRuleIds: ['sc-04', 'sr-02'],
  },
  {
    id: 'sr-02',
    category: 'sleep_restriction',
    statement: 'Эффективность сна должна быть выше 85%',
    explanation:
      'Эффективность сна = (время сна / время в постели) × 100%. ' +
      'Если вы спите 6 часов из 8 в постели — это 75%. ' +
      'Цель — достичь 85-90%.',
    visualizationPrompt:
      'Вы ведёте дневник сна. Видите цифру: эффективность 87%. ' +
      'Это значит, что почти всё время в постели вы действительно спите. ' +
      'Кровать стала местом для сна, не для ворочания.',
    rationale:
      'Высокая эффективность сна означает, что ваш мозг научился ' +
      'связывать кровать с быстрым засыпанием.',
    difficulty: 3,
    relatedRuleIds: ['sr-01', 'sc-03'],
  },

  // =========================================================================
  // SLEEP HYGIENE RULES
  // =========================================================================
  {
    id: 'sh-01',
    category: 'sleep_hygiene',
    statement: 'Нет кофеина после 14:00',
    explanation:
      'Кофеин имеет период полувыведения 5-6 часов. Кофе в 16:00 означает, ' +
      'что в 22:00 половина кофеина ещё в крови. Чай тоже содержит кофеин.',
    visualizationPrompt:
      'Утро. Вы наслаждаетесь чашкой кофе. После обеда — травяной чай или вода. ' +
      'К вечеру ваш организм чист от стимуляторов, и сонливость приходит естественно.',
    rationale:
      'Кофеин блокирует аденозиновые рецепторы, которые сигнализируют о сонливости. ' +
      'Даже если вы "привыкли" к кофе, он влияет на качество сна.',
    difficulty: 2,
    relatedRuleIds: ['sh-02', 'sh-03'],
  },
  {
    id: 'sh-02',
    category: 'sleep_hygiene',
    statement: 'Нет алкоголя за 3-4 часа до сна',
    explanation:
      'Алкоголь помогает уснуть, но разрушает архитектуру сна: ' +
      'меньше REM-сна, больше пробуждений во второй половине ночи.',
    visualizationPrompt:
      'Ужин в 19:00. Вы пьёте воду или сок вместо вина. К 23:00, когда вы ложитесь, ' +
      'ваш организм готов к естественному, восстанавливающему сну без химического вмешательства.',
    rationale:
      'Алкоголь — седативное средство, не снотворное. Он подавляет мозг, ' +
      'но не даёт настоящего восстанавливающего сна.',
    difficulty: 2,
    relatedRuleIds: ['sh-01', 'sh-03'],
  },
  {
    id: 'sh-03',
    category: 'sleep_hygiene',
    statement: 'Нет экранов за 1 час до сна',
    explanation:
      'Синий свет от экранов подавляет выработку мелатонина. ' +
      'Контент в соцсетях активирует мозг. Оба фактора мешают засыпанию.',
    visualizationPrompt:
      'За час до сна вы откладываете телефон в другую комнату. ' +
      'Вместо скроллинга — тёплая ванна, книга, спокойный разговор. ' +
      'Ваш мозг получает сигнал: пора замедляться.',
    rationale:
      'Синий свет имитирует дневной свет и говорит мозгу "ещё день". ' +
      'Отказ от экранов позволяет мелатонину вырабатываться естественно.',
    difficulty: 4,
    relatedRuleIds: ['sh-04', 'rl-01'],
  },
  {
    id: 'sh-04',
    category: 'sleep_hygiene',
    statement: 'Создайте прохладную, тёмную и тихую спальню',
    explanation:
      'Оптимальная температура: 16-19°C. Полная темнота (блэкаут-шторы). ' +
      'Тишина или белый шум. Удобный матрас и подушка.',
    visualizationPrompt:
      'Ваша спальня — пещера для сна. Прохладный воздух, кромешная темнота, ' +
      'тишина. Постель удобная и свежая. Вы чувствуете, как тело расслабляется ' +
      'в этом идеальном пространстве для сна.',
    rationale:
      'Температура тела должна снизиться для сна. Темнота нужна для мелатонина. ' +
      'Тишина — чтобы мозг не отвлекался.',
    difficulty: 2,
    relatedRuleIds: ['sh-03', 'rl-02'],
  },
  {
    id: 'sh-05',
    category: 'sleep_hygiene',
    statement: 'Физическая активность — да, но не поздно вечером',
    explanation:
      'Регулярные упражнения улучшают сон. Но интенсивные тренировки ' +
      'за 2-3 часа до сна могут мешать засыпанию из-за повышенного пульса и температуры.',
    visualizationPrompt:
      'Утренняя пробежка или вечерняя прогулка после работы. К вечеру тело приятно устало. ' +
      'После лёгкого ужина — спокойные занятия. Ваше тело готово к восстановительному сну.',
    rationale:
      'Физическая активность увеличивает глубокий сон. ' +
      'Но нужно время, чтобы тело успокоилось после нагрузки.',
    difficulty: 2,
    relatedRuleIds: ['sh-04', 'rl-01'],
  },
  {
    id: 'sh-06',
    category: 'sleep_hygiene',
    statement: 'Получайте яркий свет утром',
    explanation:
      'Солнечный или яркий искусственный свет в первые 30-60 минут после пробуждения ' +
      'синхронизирует циркадный ритм и улучшает сон следующей ночью.',
    visualizationPrompt:
      'Вы просыпаетесь, раздвигаете шторы. Яркий утренний свет заливает комнату. ' +
      'Вы выходите на балкон или к окну, позволяя свету попасть на лицо. ' +
      'Это сигнал для мозга: новый день начался.',
    rationale:
      'Утренний свет останавливает выработку мелатонина и "запускает" ' +
      'внутренние часы на новый 24-часовой цикл.',
    difficulty: 1,
    relatedRuleIds: ['sc-04', 'sh-03'],
  },

  // =========================================================================
  // COGNITIVE RULES
  // =========================================================================
  {
    id: 'cg-01',
    category: 'cognitive',
    statement: 'Одна плохая ночь не катастрофа',
    explanation:
      'Мозг компенсирует недосып более глубоким сном следующей ночью. ' +
      'Вы справитесь с завтрашним днём лучше, чем думаете.',
    visualizationPrompt:
      'Вы плохо спали. Но вместо паники вы думаете: "Это одна ночь. ' +
      'Мой организм умеет восстанавливаться. Сегодня я буду немного уставшим, ' +
      'но справлюсь. Следующая ночь будет лучше."',
    rationale:
      'Тревога о сне ухудшает сон. Спокойное отношение к плохой ночи ' +
      'снимает давление и помогает восстановиться быстрее.',
    difficulty: 3,
    relatedRuleIds: ['cg-02', 'cg-03'],
  },
  {
    id: 'cg-02',
    category: 'cognitive',
    statement: 'Мне не нужно 8 часов сна — мне нужен МОЙ оптимум',
    explanation:
      '"8 часов" — миф. Потребность в сне индивидуальна: от 6 до 9 часов. ' +
      'Важнее качество, чем количество.',
    visualizationPrompt:
      'Вы спите 6.5 часов, но просыпаетесь бодрым и энергичным весь день. ' +
      'Это ваш оптимум. Вам не нужно заставлять себя лежать 8 часов. ' +
      'Ваше тело знает, сколько сна ему нужно.',
    rationale:
      'Попытки спать "положенные 8 часов" создают тревогу и снижают качество сна. ' +
      'Найдите свой личный оптимум.',
    difficulty: 2,
    relatedRuleIds: ['cg-01', 'sr-01'],
  },
  {
    id: 'cg-03',
    category: 'cognitive',
    statement: 'Я не могу "заставить" себя уснуть',
    explanation:
      'Сон — непроизвольный процесс. Чем сильнее вы пытаетесь уснуть, ' +
      'тем больше активируется мозг и тем сложнее это сделать.',
    visualizationPrompt:
      'Вы лежите и думаете: "Надо уснуть, надо уснуть..." Стоп. Вы меняете мысль: ' +
      '"Я просто лежу и отдыхаю. Сон придёт сам, когда будет готов. ' +
      'Даже просто лежать с закрытыми глазами — это отдых."',
    rationale:
      'Попытки контролировать сон активируют симпатическую нервную систему — ' +
      'реакцию "бей или беги". Это противоположность состоянию сна.',
    difficulty: 4,
    relatedRuleIds: ['cg-01', 'rl-01'],
  },

  // =========================================================================
  // RELAXATION RULES
  // =========================================================================
  {
    id: 'rl-01',
    category: 'relaxation',
    statement: 'Создайте вечерний ритуал за 30-60 минут до сна',
    explanation:
      'Постоянный ритуал (приглушённый свет, травяной чай, книга, ванна) ' +
      'сигнализирует мозгу о приближении сна.',
    visualizationPrompt:
      '21:30. Вы выключаете верхний свет, оставляете только торшер. ' +
      'Завариваете ромашковый чай. Принимаете тёплый душ. Читаете спокойную книгу. ' +
      'Каждый вечер одинаково. Ваш мозг знает: скоро сон.',
    rationale:
      'Ритуалы создают условные рефлексы. Мозг учится: определённые действия = сон скоро.',
    difficulty: 2,
    relatedRuleIds: ['sh-03', 'rl-02'],
  },
  {
    id: 'rl-02',
    category: 'relaxation',
    statement: 'Диафрагмальное дыхание замедляет сердце и успокаивает',
    explanation:
      'Дышите животом, не грудью. Вдох 4 секунды, выдох 6-8 секунд. ' +
      'Длинный выдох активирует парасимпатическую нервную систему.',
    visualizationPrompt:
      'Вы лежите в темноте. Рука на животе. Медленный вдох — живот поднимается. ' +
      'Ещё более медленный выдох — живот опускается. С каждым выдохом ' +
      'напряжение уходит из тела. Сердце замедляется. Вы погружаетесь в покой.',
    rationale:
      'Длинный выдох стимулирует блуждающий нерв и активирует "режим отдыха" ' +
      'вместо "режима бей-беги".',
    difficulty: 2,
    relatedRuleIds: ['rl-01', 'rl-03'],
  },
  {
    id: 'rl-03',
    category: 'relaxation',
    statement: 'Прогрессивная мышечная релаксация: напряги → расслабь',
    explanation:
      'По очереди напрягайте группы мышц на 5 секунд, затем расслабляйте. ' +
      'От стоп до головы. Это снимает физическое напряжение.',
    visualizationPrompt:
      'Лёжа в кровати, вы начинаете со стоп. Напрягаете их сильно... и отпускаете. ' +
      'Чувствуете тепло и расслабление. Икры... напряжение... расслабление. ' +
      'Бёдра, живот, руки, плечи, лицо. Всё тело становится тяжёлым и расслабленным.',
    rationale:
      'Мы часто не замечаем мышечное напряжение. Этот метод учит распознавать ' +
      'и отпускать напряжение осознанно.',
    difficulty: 3,
    relatedRuleIds: ['rl-01', 'rl-02'],
  },
] as const;

/**
 * Get rules by category
 */
export function getRulesByCategory(category: SleepRuleCategory): ISleepRule[] {
  return SLEEP_RULES.filter((rule) => rule.category === category);
}

/**
 * Get rule by ID
 */
export function getRuleById(id: string): ISleepRule | undefined {
  return SLEEP_RULES.find((rule) => rule.id === id);
}

/**
 * Get related rules
 */
export function getRelatedRules(rule: ISleepRule): ISleepRule[] {
  return rule.relatedRuleIds
    .map((id) => getRuleById(id))
    .filter((r): r is ISleepRule => r !== undefined);
}

/**
 * Get rules sorted by difficulty
 */
export function getRulesByDifficulty(ascending = true): ISleepRule[] {
  return [...SLEEP_RULES].sort((a, b) =>
    ascending ? a.difficulty - b.difficulty : b.difficulty - a.difficulty
  );
}

/**
 * Get beginner-friendly rules (difficulty 1-2)
 */
export function getBeginnerRules(): ISleepRule[] {
  return SLEEP_RULES.filter((rule) => rule.difficulty <= 2);
}

/**
 * Get all categories with rule counts
 */
export function getCategoryStats(): Record<SleepRuleCategory, number> {
  const stats: Record<SleepRuleCategory, number> = {
    stimulus_control: 0,
    sleep_restriction: 0,
    sleep_hygiene: 0,
    cognitive: 0,
    relaxation: 0,
  };

  for (const rule of SLEEP_RULES) {
    stats[rule.category]++;
  }

  return stats;
}
