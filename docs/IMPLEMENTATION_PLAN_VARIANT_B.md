# –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –í–∞—Ä–∏–∞–Ω—Ç B (Telegram Mini App)

**–í–µ—Ä—Å–∏—è:** 1.0
**–î–∞—Ç–∞:** 2025-12-23
**–ë—é–¥–∂–µ—Ç:** $20,000-35,000
**–°—Ä–æ–∫:** 16-20 –Ω–µ–¥–µ–ª—å
**–ö–æ–º–∞–Ω–¥–∞:** 2-3 —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [Executive Summary](#executive-summary)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Ä–µ—à–µ–Ω–∏—è)
3. [–§–∞–∑—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#—Ñ–∞–∑—ã-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
4. [–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Å–ø—Ä–∏–Ω—Ç–æ–≤](#–¥–µ—Ç–∞–ª—å–Ω—ã–π-–ø–ª–∞–Ω-—Å–ø—Ä–∏–Ω—Ç–æ–≤)
5. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏)
6. [–ë—é–¥–∂–µ—Ç –∏ —Ä–µ—Å—É—Ä—Å—ã](#–±—é–¥–∂–µ—Ç-–∏-—Ä–µ—Å—É—Ä—Å—ã)
7. [–†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è](#—Ä–∏—Å–∫–∏-–∏-–º–∏—Ç–∏–≥–∞—Ü–∏—è)
8. [KPI –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞](#kpi-–∏-–∫—Ä–∏—Ç–µ—Ä–∏–∏-—É—Å–ø–µ—Ö–∞)

---

## Executive Summary

### –¶–µ–ª—å
–†–∞—Å—à–∏—Ä–∏—Ç—å SleepCore –¥–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å Telegram Mini App, –æ–±–µ—Å–ø–µ—á–∏–≤:
- Haptic-guided breathing exercises (+19% deep sleep –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª)
- Rich UI –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Fitbit/Garmin wearables
- AI-–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—É–¥–∏–æ-–∏—Å—Ç–æ—Ä–∏–∏

### –ö–ª—é—á–µ–≤—ã–µ deliverables

| –§–∞–∑–∞ | –°—Ä–æ–∫ | Deliverable |
|------|------|-------------|
| B1 | 6 –Ω–µ–¥–µ–ª—å | MVP –≤ —Ç–µ–∫—É—â–µ–º –±–æ—Ç–µ (–∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞, Sonya evolution, voice diary) |
| B2 | 6 –Ω–µ–¥–µ–ª—å | Telegram Mini App (haptic breathing, interactive UI, payments) |
| B3 | 4-8 –Ω–µ–¥–µ–ª—å | Wearables API + Dream Weaver AI stories |

### Timeline Overview

```
         –ù–µ–¥–µ–ª—è:  1  2  3  4  5  6  7  8  9  10 11 12 13 14 15 16 17 18 19 20
                  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
–§–∞–∑–∞ B1 (MVP):    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
–§–∞–∑–∞ B2 (Mini):                  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
–§–∞–∑–∞ B3 (AI+Wear):                                    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
Testing/Launch:                                                      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### High-Level Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                              USERS                                       ‚îÇ
‚îÇ                    (Telegram 1B+ MAU)                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ                               ‚îÇ
                    ‚ñº                               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      TELEGRAM BOT           ‚îÇ     ‚îÇ    TELEGRAM MINI APP        ‚îÇ
‚îÇ  (Grammy Framework)         ‚îÇ     ‚îÇ  (React + Telegram SDK)     ‚îÇ
‚îÇ                             ‚îÇ     ‚îÇ                             ‚îÇ
‚îÇ  ‚Ä¢ Commands (/start, etc)   ‚îÇ     ‚îÇ  ‚Ä¢ Haptic Breathing         ‚îÇ
‚îÇ  ‚Ä¢ Voice messages           ‚îÇ     ‚îÇ  ‚Ä¢ Sonya Avatar UI          ‚îÇ
‚îÇ  ‚Ä¢ Adaptive keyboard        ‚îÇ     ‚îÇ  ‚Ä¢ Sleep Diary Form         ‚îÇ
‚îÇ  ‚Ä¢ Text interactions        ‚îÇ     ‚îÇ  ‚Ä¢ Quest Progress           ‚îÇ
‚îÇ                             ‚îÇ     ‚îÇ  ‚Ä¢ Payments (Stars)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ                               ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ
                                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         BACKEND (Node.js/TypeScript)                     ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  API Layer   ‚îÇ  ‚îÇ  Services    ‚îÇ  ‚îÇ  AI/ML       ‚îÇ  ‚îÇ  External    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ  APIs        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ REST API   ‚îÇ  ‚îÇ ‚Ä¢ User       ‚îÇ  ‚îÇ ‚Ä¢ Whisper    ‚îÇ  ‚îÇ ‚Ä¢ Fitbit     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ WebSocket  ‚îÇ  ‚îÇ ‚Ä¢ Adaptive   ‚îÇ  ‚îÇ ‚Ä¢ GPT-4      ‚îÇ  ‚îÇ ‚Ä¢ Garmin     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Webhooks   ‚îÇ  ‚îÇ ‚Ä¢ Quest      ‚îÇ  ‚îÇ ‚Ä¢ ElevenLabs ‚îÇ  ‚îÇ ‚Ä¢ Oura       ‚îÇ ‚îÇ
‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ ‚Ä¢ Evolution  ‚îÇ  ‚îÇ ‚Ä¢ Emotion    ‚îÇ  ‚îÇ ‚Ä¢ Terra API  ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                            ‚îÇ
‚îÇ                              ‚îÇ   SQLite     ‚îÇ                            ‚îÇ
‚îÇ                              ‚îÇ   Database   ‚îÇ                            ‚îÇ
‚îÇ                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–∏—Ç–æ–≥–æ–≤–∞—è)

```
sleepcore/
‚îú‚îÄ‚îÄ src/                              # –¢–µ–∫—É—â–∏–π backend (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
‚îÇ   ‚îú‚îÄ‚îÄ architecture/
‚îÇ   ‚îú‚îÄ‚îÄ bot/telegram/
‚îÇ   ‚îú‚îÄ‚îÄ enterprise/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ mini-app/                         # –ù–û–í–û–ï: Telegram Mini App
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ breathing/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HapticBreathing.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BreathingCircle.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ patterns.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ avatar/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SonyaAvatar.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EvolutionAnimation.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ stages.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ diary/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SleepDiaryForm.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MoodSelector.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ VoiceInput.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ quests/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QuestList.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QuestProgress.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BadgeDisplay.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Button.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Card.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ProgressBar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Home.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Breathing.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Diary.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Quests.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Profile.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram.ts           # Telegram WebApp SDK
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ haptics.ts            # HapticFeedback wrapper
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.ts                # Backend API client
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ storage.ts            # Local storage
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useTelegram.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useHaptics.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useBreathing.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ store/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ userStore.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ breathingStore.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ styles/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ theme.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ global.css
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.tsx
‚îÇ   ‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ assets/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ sonya-owlet.svg
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ sonya-young.svg
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ sonya-wise.svg
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îú‚îÄ‚îÄ vite.config.ts
‚îÇ   ‚îî‚îÄ‚îÄ tsconfig.json
‚îÇ
‚îú‚îÄ‚îÄ src/modules/                      # –ù–û–í–û–ï: Backend –º–æ–¥—É–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ adaptive-keyboard/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdaptiveKeyboardService.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RuleEngine.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rules/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TimeBasedRules.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BehaviorRules.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ StreakRules.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îú‚îÄ‚îÄ evolution/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SonyaEvolutionService.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EvolutionCriteria.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îú‚îÄ‚îÄ voice/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WhisperService.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ VoiceDiaryHandler.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îú‚îÄ‚îÄ quests/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QuestService.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QuestDefinitions.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BadgeService.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îú‚îÄ‚îÄ wearables/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TerraService.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FitbitAdapter.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GarminAdapter.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îî‚îÄ‚îÄ dream-weaver/
‚îÇ       ‚îú‚îÄ‚îÄ StoryGeneratorService.ts
‚îÇ       ‚îú‚îÄ‚îÄ ThemeAnalyzer.ts
‚îÇ       ‚îú‚îÄ‚îÄ TTSService.ts
‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îÇ
‚îî‚îÄ‚îÄ docs/
    ‚îú‚îÄ‚îÄ research/                     # –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (—Å—É—â–µ—Å—Ç–≤—É—é—Ç)
    ‚îî‚îÄ‚îÄ IMPLEMENTATION_PLAN_VARIANT_B.md  # –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
```

---

## –§–∞–∑—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ B1: MVP –≤ —Ç–µ–∫—É—â–µ–º –±–æ—Ç–µ (–ù–µ–¥–µ–ª–∏ 1-6)

#### Sprint 1-2: –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ + Sonya Evolution

**–¶–µ–ª—å:** –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è UI –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ó–∞–¥–∞—á–∏:**

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û—Ü–µ–Ω–∫–∞ | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π |
|---|--------|-----------|--------|---------------|
| 1.1 | –°–æ–∑–¥–∞—Ç—å UserInteractionRepository | P0 | 4h | Backend Dev |
| 1.2 | –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å RuleEngine | P0 | 8h | Backend Dev |
| 1.3 | –°–æ–∑–¥–∞—Ç—å AdaptiveKeyboardService | P0 | 8h | Backend Dev |
| 1.4 | –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã | P0 | 6h | Backend Dev |
| 1.5 | –°–æ–∑–¥–∞—Ç—å SonyaEvolutionService | P1 | 6h | Backend Dev |
| 1.6 | –î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞–¥–∏–∏ –°–æ–Ω–∏ | P1 | 4h | Backend Dev |
| 1.7 | –°–æ–∑–¥–∞—Ç—å celebration messages | P1 | 3h | Backend Dev |
| 1.8 | –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã | P0 | 6h | Backend Dev |
| 1.9 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | P0 | 4h | QA |

**–ö–æ–¥: AdaptiveKeyboardService**

```typescript
// src/modules/adaptive-keyboard/AdaptiveKeyboardService.ts

import { InlineKeyboard } from 'grammy';
import { RuleEngine } from './RuleEngine';
import { UserInteractionRepository } from './UserInteractionRepository';

export interface AdaptationRule {
  id: string;
  condition: (context: UserContext) => boolean;
  action: KeyboardAction;
  priority: number;
}

export interface UserContext {
  userId: string;
  lastCommands: string[];
  ignoredCommands: Map<string, number>;
  timeOfDay: 'morning' | 'afternoon' | 'evening' | 'night';
  dayOfWeek: number;
  streak: number;
  isiScore: number | null;
  lastActivityDate: Date | null;
}

export class AdaptiveKeyboardService {
  constructor(
    private ruleEngine: RuleEngine,
    private interactionRepo: UserInteractionRepository
  ) {}

  async generateKeyboard(userId: string, baseCommands: string[]): Promise<InlineKeyboard> {
    const context = await this.buildUserContext(userId);
    const adaptedCommands = this.ruleEngine.applyRules(baseCommands, context);

    return this.buildKeyboard(adaptedCommands);
  }

  private async buildUserContext(userId: string): Promise<UserContext> {
    const interactions = await this.interactionRepo.getRecentInteractions(userId, 30);
    const ignoredCommands = this.calculateIgnoredCommands(interactions);

    const hour = new Date().getHours();
    const timeOfDay = hour < 6 ? 'night'
                    : hour < 12 ? 'morning'
                    : hour < 18 ? 'afternoon'
                    : hour < 22 ? 'evening' : 'night';

    return {
      userId,
      lastCommands: interactions.slice(0, 5).map(i => i.command),
      ignoredCommands,
      timeOfDay,
      dayOfWeek: new Date().getDay(),
      streak: await this.interactionRepo.getCurrentStreak(userId),
      isiScore: await this.interactionRepo.getLatestISIScore(userId),
      lastActivityDate: interactions[0]?.timestamp || null
    };
  }

  private calculateIgnoredCommands(interactions: Interaction[]): Map<string, number> {
    const ignored = new Map<string, number>();

    for (const interaction of interactions) {
      if (!interaction.wasClicked) {
        const count = ignored.get(interaction.command) || 0;
        ignored.set(interaction.command, count + 1);
      }
    }

    return ignored;
  }

  private buildKeyboard(commands: AdaptedCommand[]): InlineKeyboard {
    const keyboard = new InlineKeyboard();

    for (const cmd of commands) {
      if (cmd.highlighted) {
        keyboard.text(`‚≠ê ${cmd.label}`, cmd.callback);
      } else {
        keyboard.text(cmd.label, cmd.callback);
      }

      if (cmd.newRow) keyboard.row();
    }

    return keyboard;
  }
}
```

**–ö–æ–¥: RuleEngine**

```typescript
// src/modules/adaptive-keyboard/RuleEngine.ts

export class RuleEngine {
  private rules: AdaptationRule[] = [];

  constructor() {
    this.initializeDefaultRules();
  }

  private initializeDefaultRules(): void {
    // –ü—Ä–∞–≤–∏–ª–æ 1: –ó–∞–º–µ–Ω–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö –∫–æ–º–∞–Ω–¥
    this.addRule({
      id: 'replace-ignored-relax',
      condition: (ctx) => (ctx.ignoredCommands.get('/relax') || 0) >= 3,
      action: { type: 'replace', from: '/relax', to: '/mindful', label: '–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å' },
      priority: 10
    });

    // –ü—Ä–∞–≤–∏–ª–æ 2: –í–µ—á–µ—Ä–Ω–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –¥–Ω–µ–≤–Ω–∏–∫–µ
    this.addRule({
      id: 'evening-diary-highlight',
      condition: (ctx) => {
        const isEvening = ctx.timeOfDay === 'evening';
        const noRecentDiary = !ctx.lastCommands.includes('/diary');
        return isEvening && noRecentDiary;
      },
      action: { type: 'highlight', command: '/diary' },
      priority: 20
    });

    // –ü—Ä–∞–≤–∏–ª–æ 3: Streak achievement
    this.addRule({
      id: 'streak-share',
      condition: (ctx) => ctx.streak >= 7 && ctx.streak % 7 === 0,
      action: { type: 'add', command: '/share_achievement', label: 'üéâ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è' },
      priority: 5
    });

    // –ü—Ä–∞–≤–∏–ª–æ 4: –£—Ç—Ä–µ–Ω–Ω–∏–π –±–∞–ª–∞–Ω—Å
    this.addRule({
      id: 'morning-balance',
      condition: (ctx) => ctx.timeOfDay === 'morning',
      action: { type: 'highlight', command: '/balance' },
      priority: 15
    });

    // –ü—Ä–∞–≤–∏–ª–æ 5: –í—ã—Å–æ–∫–∏–π ISI ‚Üí —Ä–µ–ª–∞–∫—Å–∞—Ü–∏—è
    this.addRule({
      id: 'high-isi-relax',
      condition: (ctx) => ctx.isiScore !== null && ctx.isiScore >= 15,
      action: { type: 'highlight', command: '/relax' },
      priority: 25
    });
  }

  addRule(rule: AdaptationRule): void {
    this.rules.push(rule);
    this.rules.sort((a, b) => b.priority - a.priority);
  }

  applyRules(baseCommands: string[], context: UserContext): AdaptedCommand[] {
    let commands = baseCommands.map(cmd => ({
      command: cmd,
      label: this.getDefaultLabel(cmd),
      callback: cmd,
      highlighted: false,
      newRow: false
    }));

    for (const rule of this.rules) {
      if (rule.condition(context)) {
        commands = this.applyAction(commands, rule.action);
      }
    }

    return commands;
  }

  private applyAction(commands: AdaptedCommand[], action: KeyboardAction): AdaptedCommand[] {
    switch (action.type) {
      case 'replace':
        return commands.map(cmd =>
          cmd.command === action.from
            ? { ...cmd, command: action.to, label: action.label, callback: action.to }
            : cmd
        );

      case 'highlight':
        return commands.map(cmd =>
          cmd.command === action.command
            ? { ...cmd, highlighted: true }
            : cmd
        );

      case 'add':
        return [...commands, {
          command: action.command,
          label: action.label,
          callback: action.command,
          highlighted: true,
          newRow: true
        }];

      case 'remove':
        return commands.filter(cmd => cmd.command !== action.command);

      default:
        return commands;
    }
  }

  private getDefaultLabel(command: string): string {
    const labels: Record<string, string> = {
      '/start': 'üè† –ì–ª–∞–≤–Ω–∞—è',
      '/diary': 'üìî –î–Ω–µ–≤–Ω–∏–∫',
      '/balance': '‚öñÔ∏è –ë–∞–ª–∞–Ω—Å',
      '/relax': 'üßò –†–µ–ª–∞–∫—Å–∞—Ü–∏—è',
      '/mindful': 'üß† –û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å',
      '/challenges': 'üéØ –ß–µ–ª–ª–µ–Ω–¥–∂–∏',
      '/smart_tips': 'üí° –°–æ–≤–µ—Ç—ã',
      '/emotion': 'üí≠ –≠–º–æ—Ü–∏–∏',
      '/emergency': 'üÜò –ü–æ–º–æ—â—å'
    };
    return labels[command] || command;
  }
}
```

**–ö–æ–¥: SonyaEvolutionService**

```typescript
// src/modules/evolution/SonyaEvolutionService.ts

export interface EvolutionStage {
  id: 'owlet' | 'young_owl' | 'wise_owl';
  name: string;
  emoji: string;
  description: string;
  requiredDays: number;
}

export interface EvolutionCriteria {
  minDiaryEntries: number;
  minStreakDays: number;
  completedISI?: boolean;
  isiImprovement?: number;
}

export class SonyaEvolutionService {
  private stages: EvolutionStage[] = [
    {
      id: 'owlet',
      name: '–°–æ–≤—ë–Ω–æ–∫ –°–æ–Ω—è',
      emoji: 'üê£',
      description: '–¢–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ–º –ø—É—Ç—å –∫ –∑–¥–æ—Ä–æ–≤–æ–º—É —Å–Ω—É',
      requiredDays: 0
    },
    {
      id: 'young_owl',
      name: '–ú–æ–ª–æ–¥–∞—è —Å–æ–≤–∞ –°–æ–Ω—è',
      emoji: 'ü¶â',
      description: '–£–∂–µ –º–Ω–æ–≥–æ–º—É –Ω–∞—É—á–∏–ª–∏—Å—å –≤–º–µ—Å—Ç–µ',
      requiredDays: 14
    },
    {
      id: 'wise_owl',
      name: '–ú—É–¥—Ä–∞—è —Å–æ–≤–∞ –°–æ–Ω—è',
      emoji: 'ü¶â‚ú®',
      description: '–ú–∞—Å—Ç–µ—Ä –∑–¥–æ—Ä–æ–≤–æ–≥–æ —Å–Ω–∞',
      requiredDays: 30
    }
  ];

  private criteria: Record<string, EvolutionCriteria> = {
    'owlet_to_young': {
      minDiaryEntries: 10,
      minStreakDays: 7,
      completedISI: true
    },
    'young_to_wise': {
      minDiaryEntries: 25,
      minStreakDays: 21,
      isiImprovement: -3
    }
  };

  constructor(
    private userRepository: IUserRepository,
    private diaryRepository: IDiaryRepository
  ) {}

  async getCurrentStage(userId: string): Promise<EvolutionStage> {
    const user = await this.userRepository.findById(userId);
    return this.stages.find(s => s.id === user?.evolutionStage) || this.stages[0];
  }

  async checkEvolution(userId: string): Promise<EvolutionResult> {
    const currentStage = await this.getCurrentStage(userId);
    const nextStage = this.getNextStage(currentStage);

    if (!nextStage) {
      return { evolved: false, currentStage };
    }

    const criteriaKey = `${currentStage.id}_to_${nextStage.id}`;
    const criteria = this.criteria[criteriaKey];

    if (!criteria) {
      return { evolved: false, currentStage };
    }

    const canEvolve = await this.checkCriteria(userId, criteria);

    if (canEvolve) {
      await this.evolve(userId, nextStage);
      return {
        evolved: true,
        previousStage: currentStage,
        currentStage: nextStage,
        celebrationMessage: this.getCelebrationMessage(nextStage)
      };
    }

    const progress = await this.getEvolutionProgress(userId, criteria);
    return { evolved: false, currentStage, progress };
  }

  private async checkCriteria(userId: string, criteria: EvolutionCriteria): Promise<boolean> {
    const [diaryCount, streak, isiData] = await Promise.all([
      this.diaryRepository.countEntries(userId),
      this.userRepository.getCurrentStreak(userId),
      this.userRepository.getISIHistory(userId)
    ]);

    if (diaryCount < criteria.minDiaryEntries) return false;
    if (streak < criteria.minStreakDays) return false;

    if (criteria.completedISI && isiData.length === 0) return false;

    if (criteria.isiImprovement !== undefined) {
      if (isiData.length < 2) return false;
      const improvement = isiData[0].score - isiData[isiData.length - 1].score;
      if (improvement > criteria.isiImprovement) return false; // improvement is negative
    }

    return true;
  }

  private async evolve(userId: string, newStage: EvolutionStage): Promise<void> {
    await this.userRepository.updateEvolutionStage(userId, newStage.id);
    await this.userRepository.addXP(userId, this.getXPForStage(newStage));
  }

  private getCelebrationMessage(stage: EvolutionStage): string {
    const messages: Record<string, string> = {
      'young_owl': `
üéâ *–ü–æ–∑–¥—Ä–∞–≤–ª—è—é!*

–°–æ–Ω—è —ç–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–ª–∞!

üê£ ‚Üí ü¶â

–¢–µ–ø–µ—Ä—å –æ–Ω–∞ *${stage.name}*!

${stage.description}

–¢—ã –ø—Ä–æ–¥–µ–ª–∞–ª –æ—Ç–ª–∏—á–Ω—É—é —Ä–∞–±–æ—Ç—É! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ, –∏ –°–æ–Ω—è —Å—Ç–∞–Ω–µ—Ç –µ—â—ë –º—É–¥—Ä–µ–µ! üåô
      `,
      'wise_owl': `
üéä *–ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ!*

–°–æ–Ω—è –¥–æ—Å—Ç–∏–≥–ª–∞ –≤—ã—Å—à–µ–π —Ñ–æ—Ä–º—ã!

ü¶â ‚Üí ü¶â‚ú®

–¢–µ–ø–µ—Ä—å –æ–Ω–∞ *${stage.name}*!

${stage.description}

–¢—ã –Ω–∞—Å—Ç–æ—è—â–∏–π –º–∞—Å—Ç–µ—Ä –∑–¥–æ—Ä–æ–≤–æ–≥–æ —Å–Ω–∞! –°–æ–Ω—è –≥–æ—Ä–¥–∏—Ç—Å—è —Ç–æ–±–æ–π! üåü
      `
    };
    return messages[stage.id] || '';
  }

  private getNextStage(current: EvolutionStage): EvolutionStage | null {
    const currentIndex = this.stages.findIndex(s => s.id === current.id);
    return this.stages[currentIndex + 1] || null;
  }

  private getXPForStage(stage: EvolutionStage): number {
    const xp: Record<string, number> = {
      'young_owl': 100,
      'wise_owl': 250
    };
    return xp[stage.id] || 0;
  }

  async getEvolutionProgress(userId: string, criteria: EvolutionCriteria): Promise<EvolutionProgress> {
    const [diaryCount, streak] = await Promise.all([
      this.diaryRepository.countEntries(userId),
      this.userRepository.getCurrentStreak(userId)
    ]);

    return {
      diaryEntries: { current: diaryCount, required: criteria.minDiaryEntries },
      streakDays: { current: streak, required: criteria.minStreakDays },
      percentage: Math.min(100, Math.round(
        ((diaryCount / criteria.minDiaryEntries) + (streak / criteria.minStreakDays)) / 2 * 100
      ))
    };
  }

  getStageGreeting(stage: EvolutionStage): string {
    const greetings: Record<string, string[]> = {
      'owlet': [
        '–ü—Ä–∏–≤–µ—Ç! –Ø –°–æ–Ω—è, —Ç–≤–æ–π —Å–æ–≤—ë–Ω–æ–∫-–ø–æ–º–æ—â–Ω–∏–∫! üê£',
        '–£—Ö-—É—Ö! –°–æ–≤—ë–Ω–æ–∫ –°–æ–Ω—è –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å! üê£',
        '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π! –ú–∞–ª–µ–Ω—å–∫–∞—è –°–æ–Ω—è —Ä–∞–¥–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å! üê£'
      ],
      'young_owl': [
        '–ü—Ä–∏–≤–µ—Ç! –ú–æ–ª–æ–¥–∞—è —Å–æ–≤–∞ –°–æ–Ω—è –∫ —Ç–≤–æ–∏–º —É—Å–ª—É–≥–∞–º! ü¶â',
        '–£—Ö-—É—Ö! –°–æ–Ω—è –ø–æ–¥—Ä–æ—Å–ª–∞ –∏ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ–≥–∞—Ç—å! ü¶â',
        '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π, –¥—Ä—É–≥! –°–æ–Ω—è —Ä–∞–¥–∞ –≤—Å—Ç—Ä–µ—á–µ! ü¶â'
      ],
      'wise_owl': [
        '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è! –ú—É–¥—Ä–∞—è –°–æ–Ω—è –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º. ü¶â‚ú®',
        '–£—Ö-—É—Ö! –ú—É–¥—Ä–æ—Å—Ç—å –°–æ–Ω–∏ –∫ —Ç–≤–æ–∏–º —É—Å–ª—É–≥–∞–º! ü¶â‚ú®',
        '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π, –º–∞—Å—Ç–µ—Ä —Å–Ω–∞! –°–æ–Ω—è –≥–æ—Ä–¥–∞ —Ç–æ–±–æ–π! ü¶â‚ú®'
      ]
    };

    const stageGreetings = greetings[stage.id] || greetings['owlet'];
    return stageGreetings[Math.floor(Math.random() * stageGreetings.length)];
  }
}
```

#### Sprint 3-4: Voice Diary + Sleep Quests

**–¶–µ–ª—å:** –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –¥–Ω–µ–≤–Ω–∏–∫–∞ –∏ —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π

**–ó–∞–¥–∞—á–∏:**

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û—Ü–µ–Ω–∫–∞ | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π |
|---|--------|-----------|--------|---------------|
| 3.1 | –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Whisper API | P0 | 6h | Backend Dev |
| 3.2 | –°–æ–∑–¥–∞—Ç—å VoiceDiaryHandler | P0 | 8h | Backend Dev |
| 3.3 | –û–±—Ä–∞–±–æ—Ç–∫–∞ Telegram voice messages | P0 | 4h | Backend Dev |
| 3.4 | –°–æ–∑–¥–∞—Ç—å QuestService | P1 | 8h | Backend Dev |
| 3.5 | –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å 10 –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤ | P1 | 4h | Product |
| 3.6 | –°–æ–∑–¥–∞—Ç—å BadgeService | P1 | 4h | Backend Dev |
| 3.7 | UI –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–≤–µ—Å—Ç–æ–≤ –≤ –±–æ—Ç–µ | P1 | 4h | Backend Dev |
| 3.8 | Notifications –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ | P2 | 4h | Backend Dev |
| 3.9 | Unit + Integration —Ç–µ—Å—Ç—ã | P0 | 6h | QA |

**–ö–æ–¥: WhisperService**

```typescript
// src/modules/voice/WhisperService.ts

import OpenAI from 'openai';
import { createReadStream } from 'fs';
import { writeFile, unlink } from 'fs/promises';
import { v4 as uuid } from 'uuid';
import path from 'path';

export interface TranscriptionResult {
  text: string;
  language: string;
  duration: number;
  confidence: number;
}

export class WhisperService {
  private openai: OpenAI;
  private tempDir: string;

  constructor(apiKey: string, tempDir: string = '/tmp') {
    this.openai = new OpenAI({ apiKey });
    this.tempDir = tempDir;
  }

  async transcribe(audioBuffer: Buffer, mimeType: string = 'audio/ogg'): Promise<TranscriptionResult> {
    const tempFile = path.join(this.tempDir, `${uuid()}.ogg`);

    try {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±—É—Ñ–µ—Ä –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
      await writeFile(tempFile, audioBuffer);

      // –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Whisper API
      const response = await this.openai.audio.transcriptions.create({
        file: createReadStream(tempFile),
        model: 'whisper-1',
        language: 'ru',
        response_format: 'verbose_json'
      });

      return {
        text: response.text,
        language: response.language || 'ru',
        duration: response.duration || 0,
        confidence: this.calculateConfidence(response)
      };
    } finally {
      // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
      await unlink(tempFile).catch(() => {});
    }
  }

  private calculateConfidence(response: any): number {
    // Whisper –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç confidence –Ω–∞–ø—Ä—è–º—É—é,
    // –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç–≤—Ä–∏—Å—Ç–∏–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ segments
    if (!response.segments || response.segments.length === 0) {
      return 0.8; // default confidence
    }

    const avgLogprob = response.segments.reduce(
      (sum: number, seg: any) => sum + (seg.avg_logprob || 0),
      0
    ) / response.segments.length;

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º log probability –≤ confidence
    return Math.min(1, Math.max(0, Math.exp(avgLogprob)));
  }

  async transcribeFromUrl(url: string): Promise<TranscriptionResult> {
    const response = await fetch(url);
    const buffer = Buffer.from(await response.arrayBuffer());
    return this.transcribe(buffer);
  }
}
```

**–ö–æ–¥: VoiceDiaryHandler**

```typescript
// src/modules/voice/VoiceDiaryHandler.ts

import { Context } from 'grammy';
import { WhisperService } from './WhisperService';
import { DiaryService } from '../../architecture/services/implementations/DiaryService';
import { EmotionalRecognitionService } from '../../enterprise/intelligence/emotional/EnhancedEmotionalRecognitionService';

export class VoiceDiaryHandler {
  constructor(
    private whisperService: WhisperService,
    private diaryService: DiaryService,
    private emotionService: EmotionalRecognitionService,
    private bot: ITelegramBot
  ) {}

  async handleVoiceMessage(ctx: Context): Promise<void> {
    const voice = ctx.message?.voice;
    if (!voice) return;

    const userId = ctx.from?.id.toString();
    if (!userId) return;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º typing indicator
    await ctx.replyWithChatAction('typing');

    try {
      // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      const file = await ctx.api.getFile(voice.file_id);
      const fileUrl = `https://api.telegram.org/file/bot${process.env.BOT_TOKEN}/${file.file_path}`;

      // –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º
      const transcription = await this.whisperService.transcribeFromUrl(fileUrl);

      if (transcription.text.length < 10) {
        await ctx.reply(
          'üé§ –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ. –ü–æ–ø—Ä–æ–±—É–π —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Å–≤–æ—ë–º —Å–Ω–µ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏.',
          { parse_mode: 'Markdown' }
        );
        return;
      }

      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–º–æ—Ü–∏–∏ –≤ —Ç–µ–∫—Å—Ç–µ
      const emotionAnalysis = await this.emotionService.analyzeEmotion(
        { userId, chatId: ctx.chat?.id.toString() || '' },
        transcription.text,
        'adult' // –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      );

      // –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ
      const entry = await this.diaryService.createEntry({
        userId,
        content: transcription.text,
        source: 'voice',
        voiceDuration: voice.duration,
        emotion: emotionAnalysis.primaryEmotion,
        emotionIntensity: emotionAnalysis.emotionIntensity
      });

      // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
      const response = this.formatResponse(transcription, emotionAnalysis, entry);
      await ctx.reply(response, { parse_mode: 'Markdown' });

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–≤–æ–ª—é—Ü–∏—é –°–æ–Ω–∏
      await this.checkEvolutionAfterDiary(userId, ctx);

    } catch (error) {
      console.error('Voice diary error:', error);
      await ctx.reply(
        'üòî –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º.',
        { parse_mode: 'Markdown' }
      );
    }
  }

  private formatResponse(
    transcription: TranscriptionResult,
    emotion: EmotionAnalysis,
    entry: DiaryEntry
  ): string {
    const emotionEmoji = this.getEmotionEmoji(emotion.primaryEmotion);

    return `
üìî *–ó–∞–ø–∏—Å—å –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!*

üé§ _"${this.truncateText(transcription.text, 100)}"_

${emotionEmoji} –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: *${this.translateEmotion(emotion.primaryEmotion)}*
üìä –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: ${this.getIntensityBar(emotion.emotionIntensity)}

${this.getEmotionResponse(emotion)}

_–ó–∞–ø–∏—Å—å #${entry.id} ‚Ä¢ ${new Date().toLocaleDateString('ru-RU')}_
    `.trim();
  }

  private truncateText(text: string, maxLength: number): string {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
  }

  private getEmotionEmoji(emotion: string): string {
    const emojis: Record<string, string> = {
      'joy': 'üòä', 'sadness': 'üò¢', 'anger': 'üò†', 'fear': 'üò®',
      'stress': 'üò∞', 'anxiety': 'üòü', 'calm': 'üòå', 'hope': 'üåü',
      'neutral': 'üòê', 'tired': 'üò¥', 'confused': 'ü§î'
    };
    return emojis[emotion] || 'üí≠';
  }

  private translateEmotion(emotion: string): string {
    const translations: Record<string, string> = {
      'joy': '–†–∞–¥–æ—Å—Ç—å', 'sadness': '–ì—Ä—É—Å—Ç—å', 'anger': '–ó–ª–æ—Å—Ç—å',
      'fear': '–°—Ç—Ä–∞—Ö', 'stress': '–°—Ç—Ä–µ—Å—Å', 'anxiety': '–¢—Ä–µ–≤–æ–≥–∞',
      'calm': '–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ', 'hope': '–ù–∞–¥–µ–∂–¥–∞', 'neutral': '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ',
      'tired': '–£—Å—Ç–∞–ª–æ—Å—Ç—å', 'confused': '–ó–∞–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ'
    };
    return translations[emotion] || emotion;
  }

  private getIntensityBar(intensity: number): string {
    const filled = Math.round(intensity * 5);
    return '‚óè'.repeat(filled) + '‚óã'.repeat(5 - filled);
  }

  private getEmotionResponse(emotion: EmotionAnalysis): string {
    if (emotion.riskLevel === 'critical' || emotion.riskLevel === 'high') {
      return 'üíö –°–æ–Ω—è –∑–∞–º–µ—Ç–∏–ª–∞, —á—Ç–æ —Ç–µ–±–µ –Ω–µ–ø—Ä–æ—Å—Ç–æ. –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–π /emergency';
    }

    const responses: Record<string, string> = {
      'joy': 'üåü –ö–∞–∫ –∑–¥–æ—Ä–æ–≤–æ! –°–æ–Ω—è —Ä–∞–¥–∞ –∑–∞ —Ç–µ–±—è!',
      'sadness': 'üíô –°–æ–Ω—è —Ä—è–¥–æ–º. –í—Å—ë –ø—Ä–æ–π–¥—ë—Ç.',
      'stress': 'üßò –ü–æ–ø—Ä–æ–±—É–π /relax –¥–ª—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏—è.',
      'anxiety': 'üåø –î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –ø–æ–º–æ—á—å.',
      'tired': 'üåô –û—Ç–¥—ã—Ö ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–æ. –ó–∞–±–æ—Ç—å—Å—è –æ —Å–µ–±–µ.',
      'calm': '‚ú® –û—Ç–ª–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∑–¥–æ—Ä–æ–≤–æ–≥–æ —Å–Ω–∞!'
    };

    return responses[emotion.primaryEmotion] || 'üí≠ –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª—Å—è.';
  }

  private async checkEvolutionAfterDiary(userId: string, ctx: Context): Promise<void> {
    // –≠—Ç–∞ –ª–æ–≥–∏–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ SonyaEvolutionService
    // Placeholder –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
  }
}
```

**–ö–æ–¥: QuestService**

```typescript
// src/modules/quests/QuestService.ts

export interface Quest {
  id: string;
  title: string;
  description: string;
  category: 'sleep' | 'diary' | 'mindfulness' | 'digital_detox';
  duration: number; // days
  criteria: QuestCriteria;
  reward: QuestReward;
  difficulty: 'easy' | 'medium' | 'hard';
  icon: string;
}

export interface QuestCriteria {
  type: 'daily' | 'cumulative' | 'streak';
  metric: string;
  target: number;
  validator: (progress: QuestProgress) => boolean;
}

export interface QuestReward {
  xp: number;
  badge?: string;
  unlocks?: string[];
}

export interface ActiveQuest {
  odzyskuestId: string
  odzyskuestId: string;
  odzyskuestId: string;
  userId: string;
  questId: string;
  startedAt: Date;
  expiresAt: Date;
  progress: Record<string, number>;
  status: 'active' | 'completed' | 'failed' | 'expired';
}

export class QuestService {
  private quests: Map<string, Quest> = new Map();

  constructor(
    private questRepository: IQuestRepository,
    private userRepository: IUserRepository,
    private notificationService: INotificationService
  ) {
    this.initializeQuests();
  }

  private initializeQuests(): void {
    const defaultQuests: Quest[] = [
      {
        id: 'sleep_7h_5d',
        title: '7 —á–∞—Å–æ–≤ —Å–Ω–∞',
        description: '–°–ø–∏ –º–∏–Ω–∏–º—É–º 7 —á–∞—Å–æ–≤ –∫–∞–∂–¥—É—é –Ω–æ—á—å –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –¥–Ω–µ–π',
        category: 'sleep',
        duration: 5,
        criteria: {
          type: 'streak',
          metric: 'sleep_hours',
          target: 7,
          validator: (p) => p.consecutiveDays >= 5
        },
        reward: { xp: 100, badge: 'consistent_sleeper' },
        difficulty: 'medium',
        icon: 'üò¥'
      },
      {
        id: 'diary_streak_7',
        title: '–î–Ω–µ–≤–Ω–∏–∫ –Ω–∞ –Ω–µ–¥–µ–ª—é',
        description: '–í–µ–¥–∏ –¥–Ω–µ–≤–Ω–∏–∫ 7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥',
        category: 'diary',
        duration: 7,
        criteria: {
          type: 'streak',
          metric: 'diary_entries',
          target: 1,
          validator: (p) => p.consecutiveDays >= 7
        },
        reward: { xp: 75, badge: 'diary_master' },
        difficulty: 'easy',
        icon: 'üìî'
      },
      {
        id: 'digital_detox_3d',
        title: '–¶–∏—Ñ—Ä–æ–≤–æ–π –¥–µ—Ç–æ–∫—Å',
        description: '–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–ª–µ—Ñ–æ–Ω –∑–∞ —á–∞—Å –¥–æ —Å–Ω–∞ 3 –¥–Ω—è',
        category: 'digital_detox',
        duration: 3,
        criteria: {
          type: 'streak',
          metric: 'no_phone_before_bed',
          target: 1,
          validator: (p) => p.consecutiveDays >= 3
        },
        reward: { xp: 50, badge: 'digital_detox' },
        difficulty: 'easy',
        icon: 'üìµ'
      },
      {
        id: 'mindful_10_sessions',
        title: '–ü—É—Ç—å –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏',
        description: '–í—ã–ø–æ–ª–Ω–∏ 10 —Å–µ—Å—Å–∏–π —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏',
        category: 'mindfulness',
        duration: 14,
        criteria: {
          type: 'cumulative',
          metric: 'relax_sessions',
          target: 10,
          validator: (p) => p.totalCount >= 10
        },
        reward: { xp: 120, badge: 'mindful_master' },
        difficulty: 'medium',
        icon: 'üßò'
      },
      {
        id: 'sleep_quality_improve',
        title: '–£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞',
        description: '–£–ª—É—á—à–∏ –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ –Ω–∞ 1 –±–∞–ª–ª –∑–∞ 2 –Ω–µ–¥–µ–ª–∏',
        category: 'sleep',
        duration: 14,
        criteria: {
          type: 'cumulative',
          metric: 'sleep_quality_delta',
          target: 1,
          validator: (p) => p.qualityImprovement >= 1
        },
        reward: { xp: 150, badge: 'sleep_improver' },
        difficulty: 'hard',
        icon: '‚≠ê'
      },
      {
        id: 'bedtime_routine_5d',
        title: '–†–µ–∂–∏–º –∑–∞—Å—ã–ø–∞–Ω–∏—è',
        description: '–õ–æ–∂–∏—Å—å —Å–ø–∞—Ç—å –≤ –æ–¥–Ω–æ –≤—Ä–µ–º—è (¬±30 –º–∏–Ω) 5 –¥–Ω–µ–π',
        category: 'sleep',
        duration: 5,
        criteria: {
          type: 'streak',
          metric: 'consistent_bedtime',
          target: 1,
          validator: (p) => p.consecutiveDays >= 5
        },
        reward: { xp: 80, badge: 'routine_master' },
        difficulty: 'medium',
        icon: 'üïê'
      },
      {
        id: 'voice_diary_5',
        title: '–ì–æ–ª–æ—Å–æ–≤–æ–π –¥–Ω–µ–≤–Ω–∏–∫',
        description: '–ó–∞–ø–∏—à–∏ 5 –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ –¥–Ω–µ–≤–Ω–∏–∫',
        category: 'diary',
        duration: 10,
        criteria: {
          type: 'cumulative',
          metric: 'voice_entries',
          target: 5,
          validator: (p) => p.totalCount >= 5
        },
        reward: { xp: 60, badge: 'voice_journaler' },
        difficulty: 'easy',
        icon: 'üé§'
      },
      {
        id: 'emotion_tracking_14d',
        title: '–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä',
        description: '–û—Ç—Å–ª–µ–∂–∏–≤–∞–π —ç–º–æ—Ü–∏–∏ 14 –¥–Ω–µ–π',
        category: 'diary',
        duration: 14,
        criteria: {
          type: 'cumulative',
          metric: 'emotion_logs',
          target: 14,
          validator: (p) => p.totalCount >= 14
        },
        reward: { xp: 100, badge: 'emotion_aware' },
        difficulty: 'medium',
        icon: 'üí≠'
      },
      {
        id: 'weekend_warrior',
        title: '–í—ã—Ö–æ–¥–Ω–æ–π —Ä–µ–∂–∏–º',
        description: '–°–æ—Ö—Ä–∞–Ω–∏ —Ä–µ–∂–∏–º —Å–Ω–∞ –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ (2 –Ω–µ–¥–µ–ª–∏)',
        category: 'sleep',
        duration: 14,
        criteria: {
          type: 'cumulative',
          metric: 'weekend_routine',
          target: 4,
          validator: (p) => p.weekendSuccesses >= 4
        },
        reward: { xp: 130, badge: 'weekend_warrior' },
        difficulty: 'hard',
        icon: 'üèÜ'
      },
      {
        id: 'breathing_master',
        title: '–ú–∞—Å—Ç–µ—Ä –¥—ã—Ö–∞–Ω–∏—è',
        description: '–í—ã–ø–æ–ª–Ω–∏ 20 –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π',
        category: 'mindfulness',
        duration: 30,
        criteria: {
          type: 'cumulative',
          metric: 'breathing_sessions',
          target: 20,
          validator: (p) => p.totalCount >= 20
        },
        reward: { xp: 200, badge: 'breathing_master', unlocks: ['advanced_breathing'] },
        difficulty: 'hard',
        icon: 'üå¨Ô∏è'
      }
    ];

    for (const quest of defaultQuests) {
      this.quests.set(quest.id, quest);
    }
  }

  async getAvailableQuests(userId: string): Promise<Quest[]> {
    const activeQuests = await this.questRepository.getActiveQuests(userId);
    const completedQuests = await this.questRepository.getCompletedQuestIds(userId);

    const activeQuestIds = new Set(activeQuests.map(q => q.questId));
    const completedQuestIds = new Set(completedQuests);

    return Array.from(this.quests.values())
      .filter(quest => !activeQuestIds.has(quest.id))
      .filter(quest => !completedQuestIds.has(quest.id))
      .slice(0, 5); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 5 –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤
  }

  async startQuest(userId: string, questId: string): Promise<ActiveQuest> {
    const quest = this.quests.get(questId);
    if (!quest) throw new Error(`Quest ${questId} not found`);

    const existingActive = await this.questRepository.getActiveQuests(userId);
    if (existingActive.length >= 3) {
      throw new Error('Maximum 3 active quests allowed');
    }

    const activeQuest: ActiveQuest = {
      odzyskuestId: `${userId}_${questId}_${Date.now()}`,
      odzyskuestId: `${userId}_${questId}_${Date.now()}`,
      odzyskuestId: `${userId}_${questId}_${Date.now()}`,
      userId,
      questId,
      startedAt: new Date(),
      expiresAt: new Date(Date.now() + quest.duration * 24 * 60 * 60 * 1000),
      progress: {},
      status: 'active'
    };

    await this.questRepository.create(activeQuest);
    return activeQuest;
  }

  async updateProgress(userId: string, metric: string, value: number): Promise<void> {
    const activeQuests = await this.questRepository.getActiveQuests(userId);

    for (const activeQuest of activeQuests) {
      const quest = this.quests.get(activeQuest.questId);
      if (!quest || quest.criteria.metric !== metric) continue;

      activeQuest.progress[metric] = (activeQuest.progress[metric] || 0) + value;
      await this.questRepository.update(activeQuest);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
      if (quest.criteria.validator(this.buildQuestProgress(activeQuest))) {
        await this.completeQuest(userId, activeQuest);
      }
    }
  }

  private async completeQuest(userId: string, activeQuest: ActiveQuest): Promise<void> {
    const quest = this.quests.get(activeQuest.questId)!;

    activeQuest.status = 'completed';
    await this.questRepository.update(activeQuest);

    // –ù–∞—á–∏—Å–ª—è–µ–º –Ω–∞–≥—Ä–∞–¥—ã
    await this.userRepository.addXP(userId, quest.reward.xp);

    if (quest.reward.badge) {
      await this.userRepository.addBadge(userId, quest.reward.badge);
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    await this.notificationService.sendQuestCompleted(userId, quest);
  }

  private buildQuestProgress(activeQuest: ActiveQuest): QuestProgress {
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º raw progress –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞
    return {
      consecutiveDays: activeQuest.progress['consecutive_days'] || 0,
      totalCount: Object.values(activeQuest.progress).reduce((a, b) => a + b, 0),
      qualityImprovement: activeQuest.progress['quality_delta'] || 0,
      weekendSuccesses: activeQuest.progress['weekend_success'] || 0
    };
  }

  formatQuestMessage(quest: Quest, active?: ActiveQuest): string {
    const statusEmoji = active
      ? (active.status === 'completed' ? '‚úÖ' : 'üîÑ')
      : 'üìã';

    let message = `
${statusEmoji} *${quest.icon} ${quest.title}*
${quest.description}

‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${quest.duration} –¥–Ω–µ–π
üíé –ù–∞–≥—Ä–∞–¥–∞: ${quest.reward.xp} XP
${quest.reward.badge ? `üèÖ –ë–µ–π–¥–∂: ${quest.reward.badge}` : ''}
    `.trim();

    if (active && active.status === 'active') {
      const progress = this.calculateProgressPercentage(quest, active);
      message += `\n\nüìä –ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress}%`;
      message += `\n‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: ${this.getDaysRemaining(active)} –¥–Ω–µ–π`;
    }

    return message;
  }

  private calculateProgressPercentage(quest: Quest, active: ActiveQuest): number {
    const progress = this.buildQuestProgress(active);
    // Simplified calculation
    return Math.min(100, Math.round(
      (Object.values(active.progress).reduce((a, b) => a + b, 0) / quest.criteria.target) * 100
    ));
  }

  private getDaysRemaining(active: ActiveQuest): number {
    const now = new Date();
    const expires = new Date(active.expiresAt);
    return Math.max(0, Math.ceil((expires.getTime() - now.getTime()) / (24 * 60 * 60 * 1000)));
  }
}
```

#### Sprint 5-6: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑—ã B1

**–ó–∞–¥–∞—á–∏:**

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û—Ü–µ–Ω–∫–∞ | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π |
|---|--------|-----------|--------|---------------|
| 5.1 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π –≤ EnterpriseStartupFactory | P0 | 4h | Backend Dev |
| 5.2 | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ —Å –Ω–æ–≤—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ | P0 | 6h | Backend Dev |
| 5.3 | End-to-end —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | P0 | 8h | QA |
| 5.4 | Performance —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | P1 | 4h | Backend Dev |
| 5.5 | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API | P1 | 4h | Backend Dev |
| 5.6 | –î–µ–ø–ª–æ–π staging | P0 | 2h | DevOps |
| 5.7 | UAT —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | P0 | 8h | QA + Product |
| 5.8 | Bug fixes | P0 | 8h | Backend Dev |
| 5.9 | –†–µ–ª–∏–∑ –§–∞–∑—ã B1 | P0 | 2h | Team |

---

### –§–∞–∑–∞ B2: Telegram Mini App (–ù–µ–¥–µ–ª–∏ 7-12)

#### Sprint 7-8: –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Mini App

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –æ—Å–Ω–æ–≤—É Mini App —Å navigation –∏ Telegram SDK –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π

**–ó–∞–¥–∞—á–∏:**

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û—Ü–µ–Ω–∫–∞ | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π |
|---|--------|-----------|--------|---------------|
| 7.1 | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (Vite + React + TypeScript) | P0 | 2h | Frontend Dev |
| 7.2 | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Mini App SDK | P0 | 4h | Frontend Dev |
| 7.3 | –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (Button, Card, etc) | P0 | 6h | Frontend Dev |
| 7.4 | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—É—Ç–∏–Ω–≥–∞ | P0 | 3h | Frontend Dev |
| 7.5 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å backend API | P0 | 6h | Frontend Dev |
| 7.6 | –°–æ–∑–¥–∞–Ω–∏–µ Haptics service | P0 | 4h | Frontend Dev |
| 7.7 | –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–º—ã (—Ü–≤–µ—Ç–∞, —à—Ä–∏—Ñ—Ç—ã) | P1 | 4h | Frontend Dev |
| 7.8 | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ iOS/Android | P0 | 4h | QA |

**–ö–æ–¥: Telegram SDK Integration**

```typescript
// mini-app/src/services/telegram.ts

import WebApp from '@twa-dev/sdk';

export interface TelegramUser {
  id: number;
  firstName: string;
  lastName?: string;
  username?: string;
  languageCode?: string;
  photoUrl?: string;
}

class TelegramService {
  private webApp: typeof WebApp;

  constructor() {
    this.webApp = WebApp;
  }

  init(): void {
    this.webApp.ready();
    this.webApp.expand();

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –ø–æ–¥ —Ç–µ–º—É Telegram
    this.webApp.setHeaderColor('#1a1a2e');
    this.webApp.setBackgroundColor('#16213e');
  }

  getUser(): TelegramUser | null {
    const user = this.webApp.initDataUnsafe.user;
    if (!user) return null;

    return {
      id: user.id,
      firstName: user.first_name,
      lastName: user.last_name,
      username: user.username,
      languageCode: user.language_code,
      photoUrl: user.photo_url
    };
  }

  getInitData(): string {
    return this.webApp.initData;
  }

  close(): void {
    this.webApp.close();
  }

  showAlert(message: string): Promise<void> {
    return new Promise((resolve) => {
      this.webApp.showAlert(message, resolve);
    });
  }

  showConfirm(message: string): Promise<boolean> {
    return new Promise((resolve) => {
      this.webApp.showConfirm(message, resolve);
    });
  }

  showPopup(params: {
    title?: string;
    message: string;
    buttons?: Array<{ id: string; type: 'ok' | 'close' | 'cancel' | 'default' | 'destructive'; text: string }>;
  }): Promise<string> {
    return new Promise((resolve) => {
      this.webApp.showPopup(params, (buttonId) => resolve(buttonId || 'close'));
    });
  }

  // Main Button
  showMainButton(text: string, onClick: () => void): void {
    this.webApp.MainButton.setText(text);
    this.webApp.MainButton.onClick(onClick);
    this.webApp.MainButton.show();
  }

  hideMainButton(): void {
    this.webApp.MainButton.hide();
  }

  setMainButtonLoading(loading: boolean): void {
    if (loading) {
      this.webApp.MainButton.showProgress();
    } else {
      this.webApp.MainButton.hideProgress();
    }
  }

  // Back Button
  showBackButton(onClick: () => void): void {
    this.webApp.BackButton.onClick(onClick);
    this.webApp.BackButton.show();
  }

  hideBackButton(): void {
    this.webApp.BackButton.hide();
  }

  // Theme
  getTheme(): 'light' | 'dark' {
    return this.webApp.colorScheme;
  }

  getThemeParams() {
    return this.webApp.themeParams;
  }

  // Platform info
  getPlatform(): string {
    return this.webApp.platform;
  }

  isIOS(): boolean {
    return this.webApp.platform === 'ios';
  }

  isAndroid(): boolean {
    return this.webApp.platform === 'android';
  }

  // Viewport
  getViewportHeight(): number {
    return this.webApp.viewportHeight;
  }

  getViewportStableHeight(): number {
    return this.webApp.viewportStableHeight;
  }

  // Send data to bot
  sendData(data: string): void {
    this.webApp.sendData(data);
  }

  // Open links
  openLink(url: string): void {
    this.webApp.openLink(url);
  }

  openTelegramLink(url: string): void {
    this.webApp.openTelegramLink(url);
  }
}

export const telegram = new TelegramService();
```

**–ö–æ–¥: Haptics Service**

```typescript
// mini-app/src/services/haptics.ts

import WebApp from '@twa-dev/sdk';

export type HapticStyle = 'light' | 'medium' | 'heavy' | 'rigid' | 'soft';
export type NotificationType = 'error' | 'success' | 'warning';

class HapticsService {
  private hapticFeedback = WebApp.HapticFeedback;
  private isSupported: boolean;

  constructor() {
    this.isSupported = this.checkSupport();
  }

  private checkSupport(): boolean {
    // iOS –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ, Android —á–∞—Å—Ç–∏—á–Ω–æ
    return WebApp.platform === 'ios' || WebApp.platform === 'android';
  }

  /**
   * –õ—ë–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –¥–ª—è UI feedback
   */
  impact(style: HapticStyle = 'medium'): void {
    if (!this.isSupported) return;

    try {
      this.hapticFeedback.impactOccurred(style);
    } catch (e) {
      console.warn('Haptic impact failed:', e);
    }
  }

  /**
   * –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (success/error/warning)
   */
  notification(type: NotificationType): void {
    if (!this.isSupported) return;

    try {
      this.hapticFeedback.notificationOccurred(type);
    } catch (e) {
      console.warn('Haptic notification failed:', e);
    }
  }

  /**
   * –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ (–¥–ª—è sliders, pickers)
   */
  selectionChanged(): void {
    if (!this.isSupported) return;

    try {
      this.hapticFeedback.selectionChanged();
    } catch (e) {
      console.warn('Haptic selection failed:', e);
    }
  }

  // === BREATHING PATTERNS ===

  /**
   * –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –≤–¥–æ—Ö–∞ (–Ω–∞—Ä–∞—Å—Ç–∞—é—â–∏–π)
   */
  async breatheIn(durationMs: number = 4000): Promise<void> {
    if (!this.isSupported) return;

    const steps = 4;
    const interval = durationMs / steps;
    const styles: HapticStyle[] = ['soft', 'light', 'medium', 'heavy'];

    for (let i = 0; i < steps; i++) {
      this.impact(styles[i]);
      await this.sleep(interval);
    }
  }

  /**
   * –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ –¥—ã—Ö–∞–Ω–∏—è (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π)
   */
  async holdBreath(durationMs: number = 7000): Promise<void> {
    if (!this.isSupported) return;

    const pulseInterval = 1500;
    const pulses = Math.floor(durationMs / pulseInterval);

    for (let i = 0; i < pulses; i++) {
      this.impact('soft');
      await this.sleep(pulseInterval);
    }
  }

  /**
   * –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –≤—ã–¥–æ—Ö–∞ (–∑–∞—Ç—É—Ö–∞—é—â–∏–π)
   */
  async breatheOut(durationMs: number = 8000): Promise<void> {
    if (!this.isSupported) return;

    const steps = 4;
    const interval = durationMs / steps;
    const styles: HapticStyle[] = ['heavy', 'medium', 'light', 'soft'];

    for (let i = 0; i < steps; i++) {
      this.impact(styles[i]);
      await this.sleep(interval);
    }
  }

  /**
   * –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª 4-7-8 breathing
   */
  async breathing478Cycle(): Promise<void> {
    // 4 —Å–µ–∫—É–Ω–¥—ã –≤–¥–æ—Ö
    await this.breatheIn(4000);

    // 7 —Å–µ–∫—É–Ω–¥ –∑–∞–¥–µ—Ä–∂–∫–∞
    await this.holdBreath(7000);

    // 8 —Å–µ–∫—É–Ω–¥ –≤—ã–¥–æ—Ö
    await this.breatheOut(8000);
  }

  /**
   * Box breathing (4-4-4-4)
   */
  async boxBreathingCycle(): Promise<void> {
    // 4 —Å–µ–∫—É–Ω–¥—ã –≤–¥–æ—Ö
    await this.breatheIn(4000);

    // 4 —Å–µ–∫—É–Ω–¥—ã –∑–∞–¥–µ—Ä–∂–∫–∞
    await this.holdBreath(4000);

    // 4 —Å–µ–∫—É–Ω–¥—ã –≤—ã–¥–æ—Ö
    await this.breatheOut(4000);

    // 4 —Å–µ–∫—É–Ω–¥—ã –∑–∞–¥–µ—Ä–∂–∫–∞
    await this.holdBreath(4000);
  }

  /**
   * Relaxing breath (–º–µ–¥–ª–µ–Ω–Ω—ã–π)
   */
  async relaxingBreathCycle(): Promise<void> {
    // 6 —Å–µ–∫—É–Ω–¥ –≤–¥–æ—Ö
    await this.breatheIn(6000);

    // 2 —Å–µ–∫—É–Ω–¥—ã –ø–∞—É–∑–∞
    await this.holdBreath(2000);

    // 8 —Å–µ–∫—É–Ω–¥ –≤—ã–¥–æ—Ö
    await this.breatheOut(8000);
  }

  /**
   * Success feedback (–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è)
   */
  celebrationFeedback(): void {
    this.notification('success');
    setTimeout(() => this.impact('heavy'), 200);
    setTimeout(() => this.impact('medium'), 400);
    setTimeout(() => this.impact('light'), 600);
  }

  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

export const haptics = new HapticsService();
```

#### Sprint 9-10: Haptic Breathing Component

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π

**–ö–æ–¥: HapticBreathing Component**

```tsx
// mini-app/src/components/breathing/HapticBreathing.tsx

import React, { useState, useEffect, useCallback, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { haptics } from '../../services/haptics';
import { telegram } from '../../services/telegram';
import { BreathingCircle } from './BreathingCircle';
import { BreathingPattern, BREATHING_PATTERNS } from './patterns';
import styles from './HapticBreathing.module.css';

interface HapticBreathingProps {
  onComplete?: (cycles: number) => void;
  onCancel?: () => void;
}

type BreathingPhase = 'idle' | 'inhale' | 'hold' | 'exhale' | 'hold2' | 'complete';

export const HapticBreathing: React.FC<HapticBreathingProps> = ({
  onComplete,
  onCancel
}) => {
  const [selectedPattern, setSelectedPattern] = useState<BreathingPattern>(BREATHING_PATTERNS[0]);
  const [phase, setPhase] = useState<BreathingPhase>('idle');
  const [currentCycle, setCurrentCycle] = useState(0);
  const [totalCycles, setTotalCycles] = useState(3);
  const [timeRemaining, setTimeRemaining] = useState(0);
  const [isRunning, setIsRunning] = useState(false);

  const timerRef = useRef<NodeJS.Timeout | null>(null);
  const phaseTimerRef = useRef<NodeJS.Timeout | null>(null);

  // Cleanup timers on unmount
  useEffect(() => {
    return () => {
      if (timerRef.current) clearInterval(timerRef.current);
      if (phaseTimerRef.current) clearTimeout(phaseTimerRef.current);
    };
  }, []);

  const getPhaseInstruction = (): string => {
    switch (phase) {
      case 'inhale': return '–í–¥—ã—Ö–∞–π...';
      case 'hold': return '–ó–∞–¥–µ—Ä–∂–∏...';
      case 'exhale': return '–í—ã–¥—ã—Ö–∞–π...';
      case 'hold2': return '–ü–∞—É–∑–∞...';
      case 'complete': return '–û—Ç–ª–∏—á–Ω–æ!';
      default: return '–ì–æ—Ç–æ–≤?';
    }
  };

  const runPhase = useCallback(async (
    phaseName: BreathingPhase,
    durationMs: number,
    hapticFn: () => Promise<void>
  ): Promise<void> => {
    setPhase(phaseName);
    setTimeRemaining(Math.ceil(durationMs / 1000));

    // Start haptic pattern
    hapticFn();

    // Countdown timer
    return new Promise((resolve) => {
      let remaining = durationMs;
      timerRef.current = setInterval(() => {
        remaining -= 100;
        setTimeRemaining(Math.ceil(remaining / 1000));

        if (remaining <= 0) {
          if (timerRef.current) clearInterval(timerRef.current);
          resolve();
        }
      }, 100);
    });
  }, []);

  const runCycle = useCallback(async (): Promise<void> => {
    const pattern = selectedPattern;

    // Inhale
    await runPhase('inhale', pattern.inhale * 1000, () =>
      haptics.breatheIn(pattern.inhale * 1000)
    );

    // Hold (if pattern has it)
    if (pattern.hold > 0) {
      await runPhase('hold', pattern.hold * 1000, () =>
        haptics.holdBreath(pattern.hold * 1000)
      );
    }

    // Exhale
    await runPhase('exhale', pattern.exhale * 1000, () =>
      haptics.breatheOut(pattern.exhale * 1000)
    );

    // Hold2 (for box breathing)
    if (pattern.hold2 && pattern.hold2 > 0) {
      await runPhase('hold2', pattern.hold2 * 1000, () =>
        haptics.holdBreath(pattern.hold2 * 1000)
      );
    }
  }, [selectedPattern, runPhase]);

  const startExercise = useCallback(async () => {
    setIsRunning(true);
    setCurrentCycle(0);

    haptics.notification('success');

    for (let i = 0; i < totalCycles; i++) {
      setCurrentCycle(i + 1);
      await runCycle();
    }

    // Completion
    setPhase('complete');
    haptics.celebrationFeedback();
    setIsRunning(false);

    if (onComplete) {
      onComplete(totalCycles);
    }
  }, [totalCycles, runCycle, onComplete]);

  const stopExercise = useCallback(() => {
    if (timerRef.current) clearInterval(timerRef.current);
    if (phaseTimerRef.current) clearTimeout(phaseTimerRef.current);

    setIsRunning(false);
    setPhase('idle');
    setCurrentCycle(0);

    haptics.notification('warning');

    if (onCancel) {
      onCancel();
    }
  }, [onCancel]);

  // Setup Telegram buttons
  useEffect(() => {
    if (isRunning) {
      telegram.showMainButton('–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å', stopExercise);
    } else if (phase === 'complete') {
      telegram.showMainButton('–ì–æ—Ç–æ–≤–æ', () => {
        telegram.close();
      });
    } else {
      telegram.showMainButton('–ù–∞—á–∞—Ç—å', startExercise);
    }

    return () => {
      telegram.hideMainButton();
    };
  }, [isRunning, phase, startExercise, stopExercise]);

  return (
    <div className={styles.container}>
      {/* Pattern Selector (hidden during exercise) */}
      {!isRunning && phase !== 'complete' && (
        <div className={styles.patternSelector}>
          <h3>–í—ã–±–µ—Ä–∏ —Ç–µ—Ö–Ω–∏–∫—É –¥—ã—Ö–∞–Ω–∏—è</h3>
          <div className={styles.patterns}>
            {BREATHING_PATTERNS.map((pattern) => (
              <button
                key={pattern.id}
                className={`${styles.patternButton} ${
                  selectedPattern.id === pattern.id ? styles.selected : ''
                }`}
                onClick={() => {
                  setSelectedPattern(pattern);
                  haptics.selectionChanged();
                }}
              >
                <span className={styles.patternIcon}>{pattern.icon}</span>
                <span className={styles.patternName}>{pattern.name}</span>
                <span className={styles.patternTiming}>
                  {pattern.inhale}-{pattern.hold}-{pattern.exhale}
                  {pattern.hold2 ? `-${pattern.hold2}` : ''}
                </span>
              </button>
            ))}
          </div>

          {/* Cycles Selector */}
          <div className={styles.cyclesSelector}>
            <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏–∫–ª–æ–≤:</span>
            <div className={styles.cycleButtons}>
              {[3, 5, 7, 10].map((num) => (
                <button
                  key={num}
                  className={`${styles.cycleButton} ${
                    totalCycles === num ? styles.selected : ''
                  }`}
                  onClick={() => {
                    setTotalCycles(num);
                    haptics.selectionChanged();
                  }}
                >
                  {num}
                </button>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Breathing Circle */}
      <div className={styles.circleContainer}>
        <BreathingCircle
          phase={phase}
          timeRemaining={timeRemaining}
          pattern={selectedPattern}
        />
      </div>

      {/* Instruction */}
      <AnimatePresence mode="wait">
        <motion.div
          key={phase}
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: -20 }}
          className={styles.instruction}
        >
          {getPhaseInstruction()}
        </motion.div>
      </AnimatePresence>

      {/* Progress */}
      {isRunning && (
        <div className={styles.progress}>
          –¶–∏–∫–ª {currentCycle} –∏–∑ {totalCycles}
        </div>
      )}

      {/* Completion Message */}
      {phase === 'complete' && (
        <motion.div
          initial={{ opacity: 0, scale: 0.8 }}
          animate={{ opacity: 1, scale: 1 }}
          className={styles.completion}
        >
          <span className={styles.celebrationEmoji}>üéâ</span>
          <h2>–û—Ç–ª–∏—á–Ω–æ!</h2>
          <p>–¢—ã –≤—ã–ø–æ–ª–Ω–∏–ª {totalCycles} —Ü–∏–∫–ª–æ–≤ –¥—ã—Ö–∞–Ω–∏—è</p>
          <p className={styles.benefit}>
            {selectedPattern.benefit}
          </p>
        </motion.div>
      )}
    </div>
  );
};
```

**–ö–æ–¥: Breathing Patterns**

```typescript
// mini-app/src/components/breathing/patterns.ts

export interface BreathingPattern {
  id: string;
  name: string;
  icon: string;
  description: string;
  benefit: string;
  inhale: number;  // seconds
  hold: number;    // seconds
  exhale: number;  // seconds
  hold2?: number;  // seconds (for box breathing)
}

export const BREATHING_PATTERNS: BreathingPattern[] = [
  {
    id: '478',
    name: '4-7-8 –†–µ–ª–∞–∫—Å',
    icon: 'üåô',
    description: '–¢–µ—Ö–Ω–∏–∫–∞ –¥–æ–∫—Ç–æ—Ä–∞ –í–µ–π–ª–∞ –¥–ª—è –∑–∞—Å—ã–ø–∞–Ω–∏—è',
    benefit: '–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–∞—Ä–∞—Å–∏–º–ø–∞—Ç–∏—á–µ—Å–∫—É—é –Ω–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É, –ø–æ–º–æ–≥–∞–µ—Ç –∑–∞—Å–Ω—É—Ç—å',
    inhale: 4,
    hold: 7,
    exhale: 8
  },
  {
    id: 'box',
    name: '–ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ',
    icon: '‚¨ú',
    description: '–¢–µ—Ö–Ω–∏–∫–∞ Navy SEALs –¥–ª—è —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏',
    benefit: '–°–Ω–∏–∂–∞–µ—Ç —Å—Ç—Ä–µ—Å—Å –∏ —É–ª—É—á—à–∞–µ—Ç –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é',
    inhale: 4,
    hold: 4,
    exhale: 4,
    hold2: 4
  },
  {
    id: 'relaxing',
    name: '–£—Å–ø–æ–∫–∞–∏–≤–∞—é—â–µ–µ',
    icon: 'üçÉ',
    description: '–ì–ª—É–±–æ–∫–æ–µ –º–µ–¥–ª–µ–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ',
    benefit: '–°–Ω–∏–∂–∞–µ—Ç —Ç—Ä–µ–≤–æ–≥—É –∏ —É—Å–ø–æ–∫–∞–∏–≤–∞–µ—Ç —Ä–∞–∑—É–º',
    inhale: 6,
    hold: 2,
    exhale: 8
  },
  {
    id: 'energizing',
    name: '–ë–æ–¥—Ä—è—â–µ–µ',
    icon: '‚ö°',
    description: '–ê–∫—Ç–∏–≤–∏—Ä—É—é—â–µ–µ –¥—ã—Ö–∞–Ω–∏–µ',
    benefit: '–ü–æ–≤—ã—à–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –∏ –±–æ–¥—Ä–æ—Å—Ç—å',
    inhale: 4,
    hold: 0,
    exhale: 4
  },
  {
    id: 'coherent',
    name: '–ö–æ–≥–µ—Ä–µ–Ω—Ç–Ω–æ–µ',
    icon: 'üíö',
    description: '5.5 –≤–¥–æ—Ö–æ–≤ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è —Å–µ—Ä–¥–µ—á–Ω–æ–π –∫–æ–≥–µ—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏',
    benefit: '–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Ä–¥–µ—á–Ω–æ–≥–æ —Ä–∏—Ç–º–∞ (HRV)',
    inhale: 5,
    hold: 0,
    exhale: 5
  }
];

export const getPatternById = (id: string): BreathingPattern | undefined => {
  return BREATHING_PATTERNS.find(p => p.id === id);
};

export const getPatternDuration = (pattern: BreathingPattern): number => {
  return pattern.inhale + pattern.hold + pattern.exhale + (pattern.hold2 || 0);
};

export const getTotalDuration = (pattern: BreathingPattern, cycles: number): number => {
  return getPatternDuration(pattern) * cycles;
};

export const formatDuration = (seconds: number): string => {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  if (mins === 0) return `${secs} —Å–µ–∫`;
  if (secs === 0) return `${mins} –º–∏–Ω`;
  return `${mins} –º–∏–Ω ${secs} —Å–µ–∫`;
};
```

#### Sprint 11-12: Sonya Avatar + Payments + Integration

**–ó–∞–¥–∞—á–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–ª—è –§–∞–∑—ã B2:**

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û—Ü–µ–Ω–∫–∞ |
|---|--------|-----------|--------|
| 11.1 | Sonya Avatar component —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏ | P0 | 8h |
| 11.2 | Sleep Diary Form –≤ Mini App | P0 | 6h |
| 11.3 | Quest Progress visualization | P1 | 6h |
| 11.4 | Telegram Stars payments integration | P1 | 8h |
| 11.5 | Deep linking –º–µ–∂–¥—É Bot –∏ Mini App | P0 | 4h |
| 11.6 | –ü–æ–ª–Ω–æ–µ E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | P0 | 8h |
| 11.7 | Performance optimization | P1 | 4h |
| 11.8 | –î–µ–ø–ª–æ–π Mini App | P0 | 4h |
| 11.9 | –†–µ–ª–∏–∑ –§–∞–∑—ã B2 | P0 | 2h |

---

### –§–∞–∑–∞ B3: Wearables + Dream Weaver (–ù–µ–¥–µ–ª–∏ 13-20)

#### Sprint 13-14: Wearables Integration

**–ö–æ–¥: Terra Service (Unified Wearables API)**

```typescript
// src/modules/wearables/TerraService.ts

import axios from 'axios';

export interface SleepData {
  userId: string;
  date: string;
  duration_minutes: number;
  efficiency: number;
  stages: {
    deep_minutes: number;
    light_minutes: number;
    rem_minutes: number;
    awake_minutes: number;
  };
  heart_rate: {
    avg: number;
    min: number;
    max: number;
  };
  hrv?: number;
  respiratory_rate?: number;
}

export interface WearableConnection {
  userId: string;
  provider: 'fitbit' | 'garmin' | 'oura' | 'whoop';
  connected: boolean;
  lastSync: Date | null;
}

export class TerraService {
  private apiKey: string;
  private devId: string;
  private baseUrl = 'https://api.tryterra.co/v2';

  constructor(apiKey: string, devId: string) {
    this.apiKey = apiKey;
    this.devId = devId;
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç widget URL –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è wearable
   */
  async generateWidgetSession(
    userId: string,
    providers: string[] = ['FITBIT', 'GARMIN', 'OURA']
  ): Promise<string> {
    const response = await axios.post(
      `${this.baseUrl}/auth/generateWidgetSession`,
      {
        reference_id: userId,
        providers: providers,
        language: 'ru'
      },
      {
        headers: {
          'dev-id': this.devId,
          'x-api-key': this.apiKey
        }
      }
    );

    return response.data.url;
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Å–Ω–µ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
   */
  async getSleepData(
    terraUserId: string,
    startDate: Date,
    endDate: Date
  ): Promise<SleepData[]> {
    const response = await axios.get(
      `${this.baseUrl}/sleep`,
      {
        params: {
          user_id: terraUserId,
          start_date: startDate.toISOString().split('T')[0],
          end_date: endDate.toISOString().split('T')[0]
        },
        headers: {
          'dev-id': this.devId,
          'x-api-key': this.apiKey
        }
      }
    );

    return response.data.data.map((item: any) => this.mapSleepData(item));
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–æ—á—å —Å–Ω–∞
   */
  async getLastNightSleep(terraUserId: string): Promise<SleepData | null> {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    const data = await this.getSleepData(terraUserId, yesterday, today);
    return data.length > 0 ? data[data.length - 1] : null;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   */
  async getConnectionStatus(terraUserId: string): Promise<WearableConnection[]> {
    const response = await axios.get(
      `${this.baseUrl}/userInfo`,
      {
        params: { user_id: terraUserId },
        headers: {
          'dev-id': this.devId,
          'x-api-key': this.apiKey
        }
      }
    );

    return response.data.user.providers.map((p: any) => ({
      userId: terraUserId,
      provider: p.provider.toLowerCase(),
      connected: p.status === 'active',
      lastSync: p.last_webhook_update ? new Date(p.last_webhook_update) : null
    }));
  }

  /**
   * –î–µ–∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  async disconnect(terraUserId: string): Promise<void> {
    await axios.delete(
      `${this.baseUrl}/auth/deauthenticateUser`,
      {
        params: { user_id: terraUserId },
        headers: {
          'dev-id': this.devId,
          'x-api-key': this.apiKey
        }
      }
    );
  }

  private mapSleepData(raw: any): SleepData {
    const sleepData = raw.sleep_durations_data;

    return {
      userId: raw.user.user_id,
      date: raw.metadata.start_time.split('T')[0],
      duration_minutes: Math.round(
        (sleepData.asleep?.duration_asleep_state_seconds || 0) / 60
      ),
      efficiency: sleepData.sleep_efficiency || 0,
      stages: {
        deep_minutes: Math.round(
          (sleepData.asleep?.duration_deep_sleep_state_seconds || 0) / 60
        ),
        light_minutes: Math.round(
          (sleepData.asleep?.duration_light_sleep_state_seconds || 0) / 60
        ),
        rem_minutes: Math.round(
          (sleepData.asleep?.duration_REM_sleep_state_seconds || 0) / 60
        ),
        awake_minutes: Math.round(
          (sleepData.awake?.duration_awake_state_seconds || 0) / 60
        )
      },
      heart_rate: {
        avg: raw.heart_rate_data?.summary?.avg_hr_bpm || 0,
        min: raw.heart_rate_data?.summary?.min_hr_bpm || 0,
        max: raw.heart_rate_data?.summary?.max_hr_bpm || 0
      },
      hrv: raw.heart_rate_data?.summary?.avg_hrv_rmssd,
      respiratory_rate: raw.respiration_data?.avg_breaths_per_min
    };
  }
}
```

#### Sprint 15-16: Dream Weaver (AI Audio Stories)

**–ö–æ–¥: StoryGeneratorService**

```typescript
// src/modules/dream-weaver/StoryGeneratorService.ts

import OpenAI from 'openai';
import { TTSService } from './TTSService';
import { ThemeAnalyzer } from './ThemeAnalyzer';

export interface StoryThemes {
  stressors: string[];
  preferences: string[];
  emotionalState: string;
  timeOfDay: 'evening' | 'night';
  ageGroup: 'child' | 'teen' | 'adult';
}

export interface GeneratedStory {
  id: string;
  title: string;
  script: string;
  duration: number; // estimated minutes
  themes: string[];
  audioUrl?: string;
}

export class StoryGeneratorService {
  private openai: OpenAI;

  constructor(
    private ttsService: TTSService,
    private themeAnalyzer: ThemeAnalyzer,
    apiKey: string
  ) {
    this.openai = new OpenAI({ apiKey });
  }

  async generateStory(
    userId: string,
    diaryEntries: string[],
    preferences?: Partial<StoryThemes>
  ): Promise<GeneratedStory> {
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–º—ã –∏–∑ –¥–Ω–µ–≤–Ω–∏–∫–∞
    const themes = await this.themeAnalyzer.analyze(diaryEntries);
    const mergedThemes = { ...themes, ...preferences };

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π
    const script = await this.generateScript(mergedThemes);

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞—É–¥–∏–æ
    const audioBuffer = await this.ttsService.synthesize(script.text);
    const audioUrl = await this.ttsService.uploadAudio(audioBuffer, userId);

    return {
      id: `story_${Date.now()}`,
      title: script.title,
      script: script.text,
      duration: Math.ceil(script.text.length / 150), // ~150 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è —Å–ø–æ–∫–æ–π–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è
      themes: mergedThemes.preferences,
      audioUrl
    };
  }

  private async generateScript(themes: StoryThemes): Promise<{ title: string; text: string }> {
    const systemPrompt = this.buildSystemPrompt(themes);
    const userPrompt = this.buildUserPrompt(themes);

    const response = await this.openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt }
      ],
      temperature: 0.8,
      max_tokens: 2000
    });

    const content = response.choices[0].message.content || '';

    // –ü–∞—Ä—Å–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç
    const lines = content.split('\n');
    const title = lines[0].replace(/^#\s*/, '').trim();
    const text = lines.slice(1).join('\n').trim();

    return { title, text };
  }

  private buildSystemPrompt(themes: StoryThemes): string {
    return `
–¢—ã ‚Äî –º–∞—Å—Ç–µ—Ä –º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π –¥–ª—è —Å–Ω–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–µ,
—Ä–∞—Å—Å–ª–∞–±–ª—è—é—â–∏–µ –∏—Å—Ç–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –ª—é–¥—è–º –∑–∞—Å–Ω—É—Ç—å.

–ü—Ä–∞–≤–∏–ª–∞:
1. –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. –ò—Å–ø–æ–ª—å–∑—É–π –º–µ–¥–ª–µ–Ω–Ω—ã–π, –ø–ª–∞–≤–Ω—ã–π —Ä–∏—Ç–º –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
3. –í–∫–ª—é—á–∞–π —Å–µ–Ω—Å–æ—Ä–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è (–∑–∞–ø–∞—Ö–∏, –∑–≤—É–∫–∏, –æ—â—É—â–µ–Ω–∏—è)
4. –ò–∑–±–µ–≥–∞–π –¥—Ä–∞–º–∞—Ç–∏—á–Ω—ã—Ö –ø–æ–≤–æ—Ä–æ—Ç–æ–≤ –∏ –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
5. –ò—Å–ø–æ–ª—å–∑—É–π —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–µ –æ–±—Ä–∞–∑—ã: –ø—Ä–∏—Ä–æ–¥–∞, –≤–æ–¥–∞, –º—è–≥–∫–∏–π —Å–≤–µ—Ç
6. –î–ª–∏–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏: 800-1200 —Å–ª–æ–≤ (5-8 –º–∏–Ω—É—Ç —á—Ç–µ–Ω–∏—è)
7. –ó–∞–∫–∞–Ω—á–∏–≤–∞–π –∏—Å—Ç–æ—Ä–∏—é –ø–ª–∞–≤–Ω—ã–º –ø–µ—Ä–µ—Ö–æ–¥–æ–º –≤ —Å–æ–Ω

–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞: ${themes.ageGroup === 'child' ? '–¥–ª—è –¥–µ—Ç–µ–π (–ø—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫, —Å–∫–∞–∑–æ—á–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã)'
  : themes.ageGroup === 'teen' ? '–¥–ª—è –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤ (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã)'
  : '–¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö (–≥–ª—É–±–æ–∫–∏–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã)'}

–¢–µ–∫—É—â–µ–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${themes.emotionalState}
${themes.stressors.length > 0 ? `–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å—Ç—Ä–µ—Å—Å–∞ (–∏–∑–±–µ–≥–∞–π —ç—Ç–∏—Ö —Ç–µ–º): ${themes.stressors.join(', ')}` : ''}
    `.trim();
  }

  private buildUserPrompt(themes: StoryThemes): string {
    const settings = themes.preferences.length > 0
      ? themes.preferences.join(', ')
      : '—Å–ø–æ–∫–æ–π–Ω–∞—è –ø—Ä–∏—Ä–æ–¥–∞, –ª–µ—Å, –æ–∑–µ—Ä–æ';

    return `
–°–æ–∑–¥–∞–π —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∑–∞—Å—ã–ø–∞–Ω–∏—è.

–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞: ${settings}
–í—Ä–µ–º—è: ${themes.timeOfDay === 'night' ? '–≥–ª—É–±–æ–∫–∞—è –Ω–æ—á—å' : '–≤–µ—á–µ—Ä'}

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
# [–ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏]

[–¢–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏...]
    `.trim();
  }
}
```

---

## –ë—é–¥–∂–µ—Ç –∏ —Ä–µ—Å—É—Ä—Å—ã

### –†–∞–∑–±–∏–≤–∫–∞ –±—é–¥–∂–µ—Ç–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –§–∞–∑–∞ B1 | –§–∞–∑–∞ B2 | –§–∞–∑–∞ B3 | –ò—Ç–æ–≥–æ |
|-----------|---------|---------|---------|-------|
| **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞** | $5,000 | $12,000 | $8,000 | $25,000 |
| **–î–∏–∑–∞–π–Ω** | $500 | $2,000 | $500 | $3,000 |
| **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** | $500 | $1,000 | $500 | $2,000 |
| **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞** | $200 | $500 | $300 | $1,000 |
| **External APIs** | $100 | $200 | $500 | $800 |
| **–ë—É—Ñ–µ—Ä (15%)** | ‚Äî | ‚Äî | ‚Äî | $4,770 |
| **–ò–¢–û–ì–û** | $6,300 | $15,700 | $9,800 | **$36,570** |

### –ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (–ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞)

| –°–µ—Ä–≤–∏—Å | –°—Ç–æ–∏–º–æ—Å—Ç—å/–º–µ—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|--------|---------------|------------|
| OpenAI Whisper | ~$50-100 | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç voice messages |
| OpenAI GPT-4o | ~$50-100 | Dream Weaver stories |
| ElevenLabs TTS | ~$100-200 | Audio stories |
| Terra API | ~$100-200 | Wearables data |
| Hosting (Vercel/Railway) | ~$50 | Mini App hosting |
| **–ò–¢–û–ì–û** | **$350-650/–º–µ—Å** | –ü—Ä–∏ 1000 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |

### –ö–æ–º–∞–Ω–¥–∞

| –†–æ–ª—å | –ó–∞–Ω—è—Ç–æ—Å—Ç—å | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å |
|------|-----------|-----------------|
| **Backend Developer** | Full-time | Bot, API, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ |
| **Frontend Developer** | Full-time | Mini App |
| **QA Engineer** | Part-time | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ |
| **Product Owner** | Part-time | –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è, UX |

---

## –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|---------|-----------|
| Android haptics –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | Visual fallback, iOS-first —Å—Ç—Ä–∞—Ç–µ–≥–∏—è |
| Whisper accuracy –¥–ª—è Russian | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ–µ | Fine-tuned –º–æ–¥–µ–ª—å, user correction UI |
| Terra API –∏–∑–º–µ–Ω–µ–Ω–∏—è | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–æ–µ | –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è —á–µ—Ä–µ–∑ adapter pattern |
| Telegram Mini App bugs | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ–µ | Thorough testing, fallback –∫ –±–æ—Ç—É |
| –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ –Ω–∞ APIs | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ–µ | Rate limiting, caching, usage alerts |
| –ó–∞–¥–µ—Ä–∂–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ–µ | Agile sprints, MVP-first approach |

---

## KPI –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

### –§–∞–∑–∞ B1 (–Ω–µ–¥–µ–ª—è 6)

| KPI | Target | –ú–µ—Ç–æ–¥ –∏–∑–º–µ—Ä–µ–Ω–∏—è |
|-----|--------|-----------------|
| Voice diary adoption | 20% users | Analytics |
| Adaptive keyboard CTR | +10% vs baseline | A/B test |
| Sonya evolution rate | 30% reach stage 2 | Database query |
| Quest completion | 40% started quests | Database query |

### –§–∞–∑–∞ B2 (–Ω–µ–¥–µ–ª—è 12)

| KPI | Target | –ú–µ—Ç–æ–¥ –∏–∑–º–µ—Ä–µ–Ω–∏—è |
|-----|--------|-----------------|
| Mini App MAU | 500+ | Telegram analytics |
| Breathing sessions/user | 3+/week | Analytics |
| Haptic satisfaction | 4.0+/5.0 | In-app survey |
| Mini App retention D7 | 30%+ | Cohort analysis |

### –§–∞–∑–∞ B3 (–Ω–µ–¥–µ–ª—è 20)

| KPI | Target | –ú–µ—Ç–æ–¥ –∏–∑–º–µ—Ä–µ–Ω–∏—è |
|-----|--------|-----------------|
| Wearables connected | 15% users | Database query |
| Dream Weaver usage | 10% evening users | Analytics |
| Sleep quality improvement | +0.5 pts | ISI scores |
| Overall NPS | 40+ | Survey |

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ—ç—Ç–∞–ø–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –í–∞—Ä–∏–∞–Ω—Ç–∞ B —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Ä–∏—Å–∫–∞–º–∏ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ.

**–ö–ª—é—á–µ–≤—ã–µ milestone:**
- **–ù–µ–¥–µ–ª—è 6:** MVP –≤ —Ç–µ–∫—É—â–µ–º –±–æ—Ç–µ (–∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞, Sonya evolution, voice diary)
- **–ù–µ–¥–µ–ª—è 12:** Telegram Mini App (haptic breathing, rich UI)
- **–ù–µ–¥–µ–ª—è 20:** Full platform (wearables, AI stories)

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –∏ –Ω–∞—á–∞–ª–æ Sprint 1.
